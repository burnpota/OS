======================<br><b>생성계정 : 타임게이트 타임게이트</b><br><b>생성날짜 : 2016-05-01T02:37:22Z</b><br><b>마지막 답변자 : Jack, Jong Young Moon</b><br><b>마지막 수정 일자 : 2016-05-04T02:00:55Z</b><br><b>id : 500A000000U4PRaIAN</b><br>======================<br><br><b><font size=15>
제목  : Why volume was lost due to PV unknown device ? [ LVM PV unknown device 로 인한 Volume 유실 이슈 문의 ]
</font></b><br><br>======================<br><b>사전문의<br></b><br>어떤 문제/오류/결함이 발생했습니까? 기대하시는 결과는 무엇입니까?<br><br>안녕하세요. 심우택입니다.<br><br>삼성생명 Legacy 시스템 중 RHEL 5.x 환경에서 아래와 같은 중대한 문제가 발생하였습니다.<br><br>내용을 간략히 설명 드리자면, <br><br>1. 2016-04-30 오후 (정확한 시간은 업데이트 하겠습니다.) 알 수 없는 Hang 이 발생하여 iLO 에서 Cold Reboot 수행<br><br>2. /etc/fstab 에 정의된 볼륨을 찾을 수 없어 Emergency Mode 로 진입<br><br>3. /dev/cciss/ 에 PV Partition 을 찾을 수 없음<br><br>4. 하드웨어 RAID 및 Disk 검사<br><br>5. 파티션을 다시 생성하여 LVM 복구<br><br>어디서 문제가 발생했습니까? 어떤 환경에서 발생했습니까?<br><br>문제 발생 시점 기록한 내용은 아래와 같습니다.<br><br>root@FLPTDE01 /root # fdisk -l<br><br>Disk /dev/cciss/c0d0: 299.9 GB, 299966445568 bytes<br>255 heads, 63 sectors/track, 36468 cylinders<br>Units = cylinders of 16065 * 512 = 8225280 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d0p1   *           1         131     1052226   83  Linux<br>/dev/cciss/c0d0p2             132        4047    31455270   83  Linux<br>/dev/cciss/c0d0p3            4048       10313    50331645   82  Linux swap / Solaris<br>/dev/cciss/c0d0p4           10314       36468   210090037+   5  Extended<br>/dev/cciss/c0d0p5           10314       11618    10482381   83  Linux<br>/dev/cciss/c0d0p6           11619       36468   199607593+  8e  Linux LVM<br><br>Disk /dev/cciss/c0d1: 299.9 GB, 299966445568 bytes<br>255 heads, 32 sectors/track, 71798 cylinders<br>Units = cylinders of 8160 * 512 = 4177920 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d1p1               1       71798   292935824   8e  Linux LVM<br><br>WARNING: GPT (GUID Partition Table) detected on '/dev/cciss/c0d2'! The util fdisk doesn't support GPT. Use GNU Parted.<br><br><br>Disk /dev/cciss/c0d2: 500.0 GB, 500074307584 bytes<br>256 heads, 63 sectors/track, 60559 cylinders<br>Units = cylinders of 16128 * 512 = 8257536 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d2p1               1      266306  2147483647+  ee  EFI GPT<br>root@FLPTDE01 /root # pvs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  PV                VG   Fmt  Attr PSize   PFree<br>  /dev/cciss/c0d0p6 vg0  lvm2 a--  190.36G 40.36G<br>  /dev/cciss/c0d1p1 vg1  lvm2 a--  279.36G     0<br>  unknown device    vg1  lvm2 a-m  465.73G 92.00M<br>root@FLPTDE01 /root # vgs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  VG   #PV #LV #SN Attr   VSize   VFree<br>  vg0    1   5   0 wz--n- 190.36G 40.36G<br>  vg1    2   3   0 wz-pn- 745.09G 92.00M<br>root@FLPTDE01 /root # lvs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  LV          VG   Attr   LSize   Origin Snap%  Move Log Copy%  Convert<br>  lv_CRASH    vg0  -wi-ao  50.00G<br>  lv_DUMP     vg0  -wi-a-  50.00G<br>  lv_Tools    vg0  -wi-ao  30.00G<br>  lv_home     vg0  -wi-ao  10.00G<br>  lv_nwadmin  vg0  -wi-ao  10.00G<br>  lv_DBBACKUP vg1  -wi--- 145.00G<br>  lv_FILE     vg1  -wi--- 500.00G<br>  lv_R2WARE   vg1  -wi-a- 100.00G<br>root@FLPTDE01 /root # cat /etc/fstab<br>LABEL=/                 /                       ext3    defaults        1 1<br>LABEL=/var              /var                    ext3    defaults        1 2<br>LABEL=/boot             /boot                   ext3    defaults        1 2<br>tmpfs                   /dev/shm                tmpfs   defaults        0 0<br>devpts                  /dev/pts                devpts  gid=5,mode=620  0 0<br>sysfs                   /sys                    sysfs   defaults        0 0<br>proc                    /proc                   proc    defaults        0 0<br>LABEL=SW-cciss/c0d0p3   swap                    swap    defaults        0 0<br>/dev/vg0/lv_home        /home                   ext3    defaults        1 2<br>/dev/vg0/lv_CRASH       /CRASH                  ext3    defaults        1 2<br>/dev/vg0/lv_nwadmin     /nwadmin                ext3    defaults        1 2<br>/dev/vg0/lv_Tools       /Tools                  ext3    defaults        1 2<br>#/dev/vg1/lv_R2WARE     /tdms/R2WARE            ext3    defaults        1 2<br>#/dev/vg1/lv_FILE       /tdms/FILE              ext3    defaults        1 2<br>#/dev/vg1/lv_DBBACKUP   /tdms/DBBACKUP          ext3    defaults        1 2<br><br>언제 문제가 발생했습니까? 이러한 문제가 자주 발생합니까? 반복적으로 발생합니까? 특정 시간에 발생합니까?<br><br>위 기록을 보면 /dev/cciss/c0d2p1 파티션이 fdisk 상으로는 존재하나,<br><br>실제로 /dev/cciss 에서는 Device 파일이 없으며,<br><br>PV 에서도  unknown device 로 인식되는 문제 입니다.<br><br>아래 명령을 이용하여 데이터를 수집하였습니다.<br><br># pvs &gt; /tmp/FLPTDE01-LVM-Log/pvs.log<br># vgs &gt; /tmp/FLPTDE01-LVM-Log/vgs.log<br># lvs &gt; /tmp/FLPTDE01-LVM-Log/lvs.log<br><br># file -s /dev/vg1/lv_FILE &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE_type.out<br># dumpe2fs /dev/vg1/lv_FILE &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE.out<br># e2image -r /dev/vg1/lv_FILE -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE_metadata.e2i.bz2<br><br># file -s /dev/vg1/lv_R2WARE &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE_type.out<br># dumpe2fs /dev/vg1/lv_R2WARE &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE.out<br># e2image -r /dev/vg1/lv_R2WARE -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE_metadata.e2i.bz2<br><br># file -s /dev/vg1/lv_DBBACKUP &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP_type.out<br># dumpe2fs /dev/vg1/lv_DBBACKUP &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP.out<br># e2image -r /dev/vg1/lv_DBBACKUP -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP_metadata.e2i.bz2<br><br>문제 해결 기간 및  긴급도와 관련된 정보를 제공해 주시겠습니까?<br><br>sosreport 는 메일 받으면 추가로 업로드 하겠습니다.<br><br>감사합니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 5.5</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 3 (Normal)</b><br><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0aA000000H4JsPIAV"><br>======================<br><b>생성계정 : Moon, Jack, Jong Young</b><br><b>생성날짜 : 2016-05-04T02:00:54Z</b><br><b>마지막 답변자 : Moon, Jack, Jong Young</b><br><b>마지막 수정 일자 : 2016-05-04T02:00:54Z</b><br><br>안녕하세요.<br><br>Red Hat Global Support Service를 이용해주셔서 감사합니다.<br><br>먼저, 피드백 감사드리며 답변이 도움이 되신거 같아서 다행입니다. 요청하신대로 본 케이스는 처리완료하도록 하겠습니다.<br>만약 본 케이스와 관련하여 추가 질문이 있으시다면 언제든지 재 오픈 하실 수 있습니다.<br><br>케이스가 처리 완료되면 고객 설문조사 메일이 발송됩니다. 고객님께서 남기신 의견은 보다 나은 서비스를 위해 지속적으로 반영될 것입니다.<br>향후 기술 지원 서비스의 품질 향상을 위해, 소중한 시간을 내어 주시면 대단히 감사드리겠습니다.<br><br>감사합니다.<br><br><publishedDate>2016-05-04T02:00:54Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000H3rsGIAR"><br>======================<br><b>생성계정 : Moon, Jack, Jong Young</b><br><b>생성날짜 : 2016-05-03T02:04:16Z</b><br><b>마지막 답변자 : Moon, Jack, Jong Young</b><br><b>마지막 수정 일자 : 2016-05-03T02:04:16Z</b><br><br>안녕하세요, 심우택 차장님!<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>올려주신 문의내용을 저희 스토리지 전문그룹으로 의뢰를 하였는데, 아래와 같은 답변을 받아서 안내를 드립니다.<br><br><br>- 아래<br><br>만약, sosreport 가 이슈시점에 생성되었다면 LV 들에 해당하는 디바이스가 빠졌을것입니다. 이렇게 하여<br>VG 는 activation 을 하지 못했을것입니다. <br><br>sosreport 내에 /proc/partition 을 보면,<br><br> 104    32  488353816 cciss/c0d2<br><br><br>c0d2 는 partition 이 없습니다. 그래서, PV metadata 를 찾았다 하더라도 PV 는 간주되지 않고, metadata<br>는 잘못된 offset 을 가지는 b/c 를 무시될것입니다.<br><br>보통 저희는 디바이스의 시작으로부터 0x200 상의 PV header 를 예상하지만, partition 이 없이는 더 이상 할 수<br>있는것이 없습니다. 그래서, 저희는 corruption 을 예방하기 위한것으로는 이를 그냥 무시할것입니다.<br><br>( 모든 lvm offset 이 물리적인 디바이스의 시작과 관련이 있습니다. )<br><br>그리고, 복구하신 절차는 올바르게 진행을 하셨고, partition 을 복구하기에는 충분합니다만, 이는 LVM Metadata 가<br>실제로 어디서 시작하는지에 달려 있습니다.<br><br>이는 디바이스의 첫번째 10MB 를 dd 를 통해서 가져와야만 문제 분석이 가능합니다.<br><br><br>다음번에 동일한 문제가 발생이 된다면 아래 명령을 수행한 결과를 케이스에 업로드 부탁드립니다.<br>$ dd if=&lt;device&gt; of=/tmp/device.dd iflag=direct count=10 bs=1M<br><br>  lv_DBBACKUP vg1  -wi--- 145.00G                                       /dev/cciss/c0d1p1(51200)<br>  lv_DBBACKUP vg1  -wi--- 145.00G                                       unknown device(102307)  <br>  lv_FILE     vg1  -wi--- 500.00G                                       /dev/cciss/c0d1p1(12800)<br>  lv_FILE     vg1  -wi--- 500.00G                                       /dev/cciss/c0d1p1(71424)<br>  lv_FILE     vg1  -wi--- 500.00G                                       unknown device(0)<br><br><br>감사합니다.<br><br><publishedDate>2016-05-03T02:04:16Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000H3PVGIA3"><br>======================<br><b>생성계정 : Moon, Jack, Jong Young</b><br><b>생성날짜 : 2016-05-02T03:41:25Z</b><br><b>마지막 답변자 : Moon, Jack, Jong Young</b><br><b>마지막 수정 일자 : 2016-05-02T03:41:25Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>현재 올려주신 문의내용을 자세히 살펴보고 있는중입니다. 확인이 되는대로 업데이트를 남기도록 하겠습니다.<br><br>감사합니다.<br><br><publishedDate>2016-05-02T03:41:25Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000H3OsEIAV"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2016-05-02T00:26:06Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2016-05-02T00:26:06Z</b><br><br>안녕하세요. 심우택입니다.<br><br>dropbox.redhat.com 에 sosreport-FLPTDE01-253686-4032c9.tar.bz2 파일명으로 sosreport 업로드 하였습니다.<br><br>본 이슈에 대해서 원인분석/버그 여부 확인 부탁 드립니다.<br><br>감사합니다.<br><br><publishedDate>2016-05-02T00:26:06Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000H3N8BIAV"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2016-05-01T02:38:27Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2016-05-01T02:38:27Z</b><br><br>본 케이스에 제 메일주소 wshim@redhat.com 도 포함 부탁 드립니다.<br><br>감사합니다.<br><br><publishedDate>2016-05-01T02:38:27Z</publishedDate><createdByType>Customer</createdByType><br>======================<br></comments><br><br>삼성생명 Legacy 시스템 중 RHEL 5.x 환경에서 아래와 같은 중대한 문제가 발생하였습니다.<br><br>내용을 간략히 설명 드리자면, <br><br>1. 2016-04-30 오후 (정확한 시간은 업데이트 하겠습니다.) 알 수 없는 Hang 이 발생하여 iLO 에서 Cold Reboot 수행<br><br>2. /etc/fstab 에 정의된 볼륨을 찾을 수 없어 Emergency Mode 로 진입<br><br>3. /dev/cciss/ 에 PV Partition 을 찾을 수 없음<br><br>4. 하드웨어 RAID 및 Disk 검사<br><br>5. 파티션을 다시 생성하여 LVM 복구</issue><environment>문제 발생 시점 기록한 내용은 아래와 같습니다.<br><br>root@FLPTDE01 /root # fdisk -l<br><br>Disk /dev/cciss/c0d0: 299.9 GB, 299966445568 bytes<br>255 heads, 63 sectors/track, 36468 cylinders<br>Units = cylinders of 16065 * 512 = 8225280 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d0p1   *           1         131     1052226   83  Linux<br>/dev/cciss/c0d0p2             132        4047    31455270   83  Linux<br>/dev/cciss/c0d0p3            4048       10313    50331645   82  Linux swap / Solaris<br>/dev/cciss/c0d0p4           10314       36468   210090037+   5  Extended<br>/dev/cciss/c0d0p5           10314       11618    10482381   83  Linux<br>/dev/cciss/c0d0p6           11619       36468   199607593+  8e  Linux LVM<br><br>Disk /dev/cciss/c0d1: 299.9 GB, 299966445568 bytes<br>255 heads, 32 sectors/track, 71798 cylinders<br>Units = cylinders of 8160 * 512 = 4177920 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d1p1               1       71798   292935824   8e  Linux LVM<br><br>WARNING: GPT (GUID Partition Table) detected on '/dev/cciss/c0d2'! The util fdisk doesn't support GPT. Use GNU Parted.<br><br><br>Disk /dev/cciss/c0d2: 500.0 GB, 500074307584 bytes<br>256 heads, 63 sectors/track, 60559 cylinders<br>Units = cylinders of 16128 * 512 = 8257536 bytes<br><br>           Device Boot      Start         End      Blocks   Id  System<br>/dev/cciss/c0d2p1               1      266306  2147483647+  ee  EFI GPT<br>root@FLPTDE01 /root # pvs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  PV                VG   Fmt  Attr PSize   PFree<br>  /dev/cciss/c0d0p6 vg0  lvm2 a--  190.36G 40.36G<br>  /dev/cciss/c0d1p1 vg1  lvm2 a--  279.36G     0<br>  unknown device    vg1  lvm2 a-m  465.73G 92.00M<br>root@FLPTDE01 /root # vgs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  VG   #PV #LV #SN Attr   VSize   VFree<br>  vg0    1   5   0 wz--n- 190.36G 40.36G<br>  vg1    2   3   0 wz-pn- 745.09G 92.00M<br>root@FLPTDE01 /root # lvs<br>  Couldn't find device with uuid tHnwXc-74BP-2DQi-nmQe-5t3v-LI1m-GZ7DHL.<br>  LV          VG   Attr   LSize   Origin Snap%  Move Log Copy%  Convert<br>  lv_CRASH    vg0  -wi-ao  50.00G<br>  lv_DUMP     vg0  -wi-a-  50.00G<br>  lv_Tools    vg0  -wi-ao  30.00G<br>  lv_home     vg0  -wi-ao  10.00G<br>  lv_nwadmin  vg0  -wi-ao  10.00G<br>  lv_DBBACKUP vg1  -wi--- 145.00G<br>  lv_FILE     vg1  -wi--- 500.00G<br>  lv_R2WARE   vg1  -wi-a- 100.00G<br>root@FLPTDE01 /root # cat /etc/fstab<br>LABEL=/                 /                       ext3    defaults        1 1<br>LABEL=/var              /var                    ext3    defaults        1 2<br>LABEL=/boot             /boot                   ext3    defaults        1 2<br>tmpfs                   /dev/shm                tmpfs   defaults        0 0<br>devpts                  /dev/pts                devpts  gid=5,mode=620  0 0<br>sysfs                   /sys                    sysfs   defaults        0 0<br>proc                    /proc                   proc    defaults        0 0<br>LABEL=SW-cciss/c0d0p3   swap                    swap    defaults        0 0<br>/dev/vg0/lv_home        /home                   ext3    defaults        1 2<br>/dev/vg0/lv_CRASH       /CRASH                  ext3    defaults        1 2<br>/dev/vg0/lv_nwadmin     /nwadmin                ext3    defaults        1 2<br>/dev/vg0/lv_Tools       /Tools                  ext3    defaults        1 2<br>#/dev/vg1/lv_R2WARE     /tdms/R2WARE            ext3    defaults        1 2<br>#/dev/vg1/lv_FILE       /tdms/FILE              ext3    defaults        1 2<br>#/dev/vg1/lv_DBBACKUP   /tdms/DBBACKUP          ext3    defaults        1 2</environment><periodicityOfIssue>위 기록을 보면 /dev/cciss/c0d2p1 파티션이 fdisk 상으로는 존재하나,<br><br>실제로 /dev/cciss 에서는 Device 파일이 없으며,<br><br>PV 에서도  unknown device 로 인식되는 문제 입니다.<br><br>아래 명령을 이용하여 데이터를 수집하였습니다.<br><br># pvs &gt; /tmp/FLPTDE01-LVM-Log/pvs.log<br># vgs &gt; /tmp/FLPTDE01-LVM-Log/vgs.log<br># lvs &gt; /tmp/FLPTDE01-LVM-Log/lvs.log<br><br># file -s /dev/vg1/lv_FILE &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE_type.out<br># dumpe2fs /dev/vg1/lv_FILE &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE.out<br># e2image -r /dev/vg1/lv_FILE -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_FILE_metadata.e2i.bz2<br><br># file -s /dev/vg1/lv_R2WARE &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE_type.out<br># dumpe2fs /dev/vg1/lv_R2WARE &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE.out<br># e2image -r /dev/vg1/lv_R2WARE -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_R2WARE_metadata.e2i.bz2<br><br># file -s /dev/vg1/lv_DBBACKUP &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP_type.out<br># dumpe2fs /dev/vg1/lv_DBBACKUP &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP.out<br># e2image -r /dev/vg1/lv_DBBACKUP -| bzip2 &gt; /tmp/FLPTDE01-LVM-Log/lv_DBBACKUP_metadata.e2i.bz2</periodicityOfIssue><timeFramesAndUrgency>sosreport 는 메일 받으면 추가로 업로드 하겠습니다.<br><br>감사합니다.</timeFramesAndUrgency><cep>false</cep></case>
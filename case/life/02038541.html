======================<br><b>생성계정 : 타임게이트 타임게이트</b><br><b>생성날짜 : 2018-02-20T07:09:56Z</b><br><b>마지막 답변자 : Jay Shin</b><br><b>마지막 수정 일자 : 2018-02-23T03:52:39Z</b><br><b>id : 500A000000ZqYB3IAN</b><br>======================<br><br><b><font size=15>
제목  : [장애분석]call trace 발생관련
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하세요.<br>현재 스플렁스 서비스를 하고있는 서버입니다.<br>메세지로그를 확인하면 지속적으로 call trace 가 발생하고 있습니다.<br>ifconfig하였을때 네트워크 상의 DROP도 확인됩니다.<br>이와같은 문제가<br>요청되는 부하대비 물리적자원 부족으로  발생하는 것인가요?<br>확인 부탁드립니다..<br><br>==============================================================================<br>* 고객 정보 (필수) - 실제 레드햇 서브스크립션을 소유하고 시스템에 사용 중인 엔드 유저<br>- 성함(직급) : 김경희 (선임)<br>- 회사명(부서명) : 삼성SDS<br>- 전화번호 :  +82-10-3049-1440 <br>- 메일주소 : 김경희 &lt;khsds.kim@samsung.com&gt;<br><br>* 파트너 정보 (옵션) - 실제 고객의 시스템을 유지보수하는 업체<br>- 성함(직급) : 송기호(책임)<br>- 회사명(부서명) : 타임게이트(오픈소스팀)<br>- 전화번호 : 01036209917<br>- 메일주소 : kh.song@time-gate.com<br>==============================================================================<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 6.4</b><br><b>타입  : Account / Customer Service Request</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 3 (Normal)</b><br><hostname>IPSIDAP2</hostname><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0aA000000LqajHIAR"><br>======================<br><b>생성계정 : Shin, Jay</b><br><b>생성날짜 : 2018-02-23T03:52:36Z</b><br><b>마지막 답변자 : Shin, Jay</b><br><b>마지막 수정 일자 : 2018-02-23T03:52:36Z</b><br><br>안녕하세요<br><br>Red Hat Global Support Services 를 이용해 주셔서 감사합니다.<br><br>먼저, 본 기술 문의가 해결되어 다행입니다.<br><br>만약 본 기술 문의와 관련하여 추가 질문이 있으시다면 언제든지 본 기술 문의를 재개하실 수 있습니다.<br><br>기술 문의가 처리 완료되면 *고객 설문조사* 메일이 발송됩니다. 고객님께서 남기신 의견은 보다 나은 서비스를 위해 지속적으로 반영될 것입니다.<br>향후 기술 지원 서비스의 품질 향상을 위해, 소중한 시간을 내어 주시면 대단히 감사드리겠습니다.<br><br>감사합니다.<br><br>Jay Shin,<br>Senior TSE, APAC<br>Red Hat Customer Experience and Engagement<br><br><publishedDate>2018-02-23T03:52:36Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Lqag3IAB"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-02-23T03:41:53Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-02-23T03:41:53Z</b><br><br>답변감사합니다.<br>해당 작업을 진행완료했고,<br>현재까지 이상없이 서비스중입니다.<br>감사합니다.<br><br><publishedDate>2018-02-23T03:41:53Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000LpwqzIAB"><br>======================<br><b>생성계정 : Shin, Jay</b><br><b>생성날짜 : 2018-02-21T00:11:31Z</b><br><b>마지막 답변자 : Shin, Jay</b><br><b>마지막 수정 일자 : 2018-02-21T00:11:31Z</b><br><br>안녕하세요<br><br>Red Hat Global Support Services 를 이용해 주셔서 감사합니다.<br><br>sosreport 를 분석한 결과, 시스템에 설치된 kernel 버전이 낮아, 해당 커널에 포함되어있는 tg3 Ethernet 드라이버의<br>버그로 인하여, 성능 향상을 위해 기본적으로 활성화된 gso/tso 패킷 재조합/분할 작업시에 사용되는 페이지의 단편화로 인하여<br>order 5 커널 페이지가 부족하여 page allocation failure 가 발생되었습니다.<br>콜트레이스에서도 tx(transmittion) 작업에 tg3 드라이버가 사용된 것이 확인됩니다.<br><br>아래 문서에 본 증상에 대한 상세한 설명을 참고하여, 커널 업그레이드 혹은 Workaround 를 고려해보시기 바랍니다.<br><br>Stale TCP connections with tg3 on Red Hat Enterprise Linux 6 <br>https://access.redhat.com/solutions/624593<br><br>Jan 13 07:22:20 IPSIDAP2 kernel: swapper: page allocation failure. order:5, mode:0x20<br>Jan 13 07:22:20 IPSIDAP2 kernel: Pid: 0, comm: swapper Tainted: P           ---------------    2.6.32-358.23.2.el6.x86_64 #1<br>Jan 13 07:22:20 IPSIDAP2 kernel: Call Trace:<br>Jan 13 07:22:20 IPSIDAP2 kernel: &lt;IRQ&gt;  [&lt;ffffffff8112c287&gt;] ? __alloc_pages_nodemask+0x757/0x8d0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8102ea2d&gt;] ? lapic_next_event+0x1d/0x30<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81166dc2&gt;] ? kmem_getpages+0x62/0x170<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff811679da&gt;] ? fallback_alloc+0x1ba/0x270<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8116742f&gt;] ? cache_grow+0x2cf/0x320<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81167759&gt;] ? ____cache_alloc_node+0x99/0x160<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81168920&gt;] ? kmem_cache_alloc_node_trace+0x90/0x200<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81168b3d&gt;] ? __kmalloc_node+0x4d/0x60<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8143de1d&gt;] ? __alloc_skb+0x6d/0x190<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8143ef40&gt;] ? skb_copy+0x40/0xb0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffffa01ef27c&gt;] ? tg3_start_xmit+0xa8c/0xd50 [tg3]<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81449428&gt;] ? dev_hard_start_xmit+0x308/0x530<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81446813&gt;] ? __napi_complete+0x23/0x40<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff814677aa&gt;] ? sch_direct_xmit+0x15a/0x1c0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8146787b&gt;] ? __qdisc_run+0x6b/0xe0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81446760&gt;] ? net_tx_action+0x130/0x1c0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff810770b1&gt;] ? __do_softirq+0xc1/0x1e0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff810e1760&gt;] ? handle_IRQ_event+0x60/0x170<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8100c1cc&gt;] ? call_softirq+0x1c/0x30<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8100de05&gt;] ? do_softirq+0x65/0xa0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81076e95&gt;] ? irq_exit+0x85/0x90<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81517775&gt;] ? do_IRQ+0x75/0xf0<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff8100b9d3&gt;] ? ret_from_intr+0x0/0x11<br>Jan 13 07:22:20 IPSIDAP2 kernel: &lt;EOI&gt;  [&lt;ffffffff812d3cfe&gt;] ? intel_idle+0xde/0x170<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff812d3ce1&gt;] ? intel_idle+0xc1/0x170<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81415647&gt;] ? cpuidle_idle_call+0xa7/0x140<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81009fc6&gt;] ? cpu_idle+0xb6/0x110<br>Jan 13 07:22:20 IPSIDAP2 kernel: [&lt;ffffffff81507600&gt;] ? start_secondary+0x2ac/0x2ef<br>Jan 13 08:25:02 IPSIDAP2 abrt: detected unhandled Python exception in '/splunk_opt/splunk/bin/scripts/check.py'<br>Jan 13 08:25:02 IPSIDAP2 abrt: can't communicate with ABRT daemon, is it running? [Errno 2] No such file or directory<br><br>말씀하신대로 rx 패킥 드랍이 발생되고 있고 tg3 드라이버의 버전은 3.124 입니다.<br><br>ETHTOOL<br>  Interface Status:<br>    bond0  link=up       rx ring UNKNOWN                    drv bonding v3.6.0 / fw 2<br>    eth10  0000:0a:00.2  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth11  0000:0a:00.3  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth4   0000:07:00.0  link=up 1000Mb/s full (autoneg=Y)  rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth5   0000:07:00.1  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth6   0000:07:00.2  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth7   0000:07:00.3  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth8   0000:0a:00.0  link=up 1000Mb/s full (autoneg=Y)  rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>    eth9   0000:0a:00.1  link=DOWN                          rx ring 200/2047           drv tg3 v3.124 / fw 5719-v1.31 NCSI v1.1.15.0<br>  Interface Errors:<br>    eth4  rx_discards: 714<br><br>아래 행 로그는 1회성으로 발생된 것으로 확인되며, nfs 서버와의 연결에 일시적인 문제가 있었을 것으로 추정하고 있습니다.<br><br>Jan 13 08:25:59 IPSIDAP2 kernel: INFO: task dd:9309 blocked for more than 120 seconds.<br>Jan 13 08:25:59 IPSIDAP2 kernel: &quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot; disables this message.<br>Jan 13 08:25:59 IPSIDAP2 kernel: dd            D 0000000000000008     0  9309   9293 0x00000080<br>Jan 13 08:25:59 IPSIDAP2 kernel: ffff8800378f99c8 0000000000000082 0000000000000000 0000000000000000<br>Jan 13 08:25:59 IPSIDAP2 kernel: ffff8800378f9988 ffffffff810097cc 0000000000000080 0000000000000400<br>Jan 13 08:25:59 IPSIDAP2 kernel: ffff88080131e5f8 ffff8800378f9fd8 000000000000fb88 ffff88080131e5f8<br>Jan 13 08:25:59 IPSIDAP2 kernel: Call Trace:<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff810097cc&gt;] ? __switch_to+0x1ac/0x320<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0dbb4f0&gt;] ? nfs_wait_bit_uninterruptible+0x0/0x20 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8150e953&gt;] io_schedule+0x73/0xc0<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0dbb4fe&gt;] nfs_wait_bit_uninterruptible+0xe/0x20 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8150f30f&gt;] __wait_on_bit+0x5f/0x90<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0dbb4f0&gt;] ? nfs_wait_bit_uninterruptible+0x0/0x20 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8150f3b8&gt;] out_of_line_wait_on_bit+0x78/0x90<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81096de0&gt;] ? wake_bit_function+0x0/0x50<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81119c1e&gt;] ? find_get_page+0x1e/0xa0<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0dbb4df&gt;] nfs_wait_on_request+0x2f/0x40 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0dc1fd2&gt;] nfs_updatepage+0x1f2/0x540 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0db05d2&gt;] nfs_write_end+0x152/0x2b0 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81119582&gt;] ? iov_iter_copy_from_user_atomic+0x92/0x130<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8111a81a&gt;] generic_file_buffered_write+0x18a/0x2e0<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8111c210&gt;] __generic_file_aio_write+0x260/0x490<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8111c4c8&gt;] generic_file_aio_write+0x88/0x100<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffffa0db000e&gt;] nfs_file_write+0xde/0x1f0 [nfs]<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8118109a&gt;] do_sync_write+0xfa/0x140<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81096da0&gt;] ? autoremove_wake_function+0x0/0x40<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8121bf26&gt;] ? security_file_permission+0x16/0x20<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81181398&gt;] vfs_write+0xb8/0x1a0<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff81181c91&gt;] sys_write+0x51/0x90<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff810dc685&gt;] ? __audit_syscall_exit+0x265/0x290<br>Jan 13 08:25:59 IPSIDAP2 kernel: [&lt;ffffffff8100b072&gt;] system_call_fastpath+0x16/0x1b<br><br>시스템에 splunk 애플리케이션이 동작하는 것으로 확인됩니다.<br><br>    splunk   47073  69.2  0.4   398      151      ?      Sl    09:50  44:28     [splunkd pid=47644] search<br><br>$ cat proc/cmdline <br>ro root=UUID=536d95bc-2ada-4c65-bb6e-9385f3256733 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=131M@0M KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet nmi_watchdog=0<br><br>io scheduler cfq registered (default)<br><br>  vm.<br>    dirty_ratio =  &quot;20&quot;  (% of total system memory)<br>    dirty_background_ratio =  &quot;10&quot;  (% of total system memory)<br>    dirty_expire_centisecs =  &quot;3000&quot;<br>    dirty_writeback_centisecs =  &quot;500&quot;<br>    swappiness [0-100] =  &quot;60&quot;<br>    min_free_kbytes = &quot;90112&quot;<br><br>분석 결과를 종합하여 call trace 발생에 대한 조치와 성능 향상을 위한 튜닝을 안내해드립니다.<br><br> 1. 커널 업그레이드를 통한 tg3 드라이버 업그레이드 혹은 문서에 언급된 gso/tso 기능 비활성<br> 2. page allocation failure 를 방지하기 위해 커널 페이지 여유공간 늘림<br>    - vm.min_free_kbytes = 270336<br> 3. dirty ratio 를 줄이기 위한 설정값 낮춤<br>    - vm.dirty_ratio = 10<br>    - vm.dirty_background_ratio = 5<br>    - vm.dirty_expire_centisecs = 1000<br>    - vm.dirty_writeback_centisecs = 100<br> 4. swap 사용 빈도를 낮추기 위한 설정값 낮춤<br>    - vm.swappiness = 10<br> 5. THP 사용으로 페이지 단편화의 가능성을 없애기 위함과 동시에 splunk 애플리케이션의 성능 저하를 막고자 THP 비활성(transparent_hugepage=never 추가 - /etc/grub.cfg) : 리부팅 필요<br>    - ro root=UUID=536d95bc-2ada-4c65-bb6e-9385f3256733 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=131M@0M KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet nmi_watchdog=0 transparent_hugepage=never<br> 6. I/O 향상을 위해 io scheduler 변경(elevator=deadline 추가 - /etc/grub.cfg) : 리부팅 필요<br>    - ro root=UUID=536d95bc-2ada-4c65-bb6e-9385f3256733 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=131M@0M KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet nmi_watchdog=0 transparent_hugepage=never elevator=deadline<br><br>만약 본 이슈와 관련하여 추가적인 문의 사항이 있으실 경우 연락 주시기 바랍니다.<br><br>감사합니다.<br><br>Jay Shin,<br>Senior TSE, APAC<br>Red Hat Customer Experience and Engagement<br><br><publishedDate>2018-02-21T00:11:31Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>
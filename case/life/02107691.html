======================<br><b>생성계정 : 타임게이트 타임게이트</b><br><b>생성날짜 : 2018-05-27T05:56:17Z</b><br><b>마지막 답변자 : Ying Huang</b><br><b>마지막 수정 일자 : 2018-05-30T05:44:23Z</b><br><b>id : 500A000000atE8dIAE</b><br>======================<br><br><b><font size=15>
제목  : ntp 동기화 실패 시간
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하세요. 생명내에서 NTP서버와 NTP클라이언트간에 4대 대해서 NTP서버와 동기화를 하지 않는 현상이 발생하였습니다.<br><br>NTP서버와 클라이언트간에 어느정의 시간차이가 발생하면 클라이언트에서 <br>서버와 NTP동기화를 하지 않는지  알고 싶습니다.<br><br>감사합니다.<br><br>==============================================================================<br>* 고객 정보 (필수) - 실제 레드햇 서브스크립션을 소유하고 시스템에 사용 중인 엔드 유저<br>- 성함(직급) : 김태현 (책임)<br>- 회사명(부서명) : 삼성SDS<br>- 전화번호 :  82-10-3734-0720<br>- 메일주소 : 김태현 &lt;th0720.kim@samsung.com&gt;<br><br>* 파트너 정보 (옵션) - 실제 고객의 시스템을 유지보수하는 업체<br>- 성함(직급) : 송기호(책임)<br>- 회사명(부서명) : 타임게이트(오픈소스팀)<br>- 전화번호 : 01036209917<br>- 메일주소 : kh.song@time-gate.com<br>==============================================================================<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>타입  : Account / Customer Service Request</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 2 (High)</b><br><hostname>NA</hostname><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0aA000000MgLj2IAF"><br>======================<br><b>생성계정 : Huang, Ying</b><br><b>생성날짜 : 2018-05-30T05:44:21Z</b><br><b>마지막 답변자 : Huang, Ying</b><br><b>마지막 수정 일자 : 2018-05-30T05:44:21Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>네, 알겠습니다.<br><br>이슈가 재현되시면 아래의 문서를 참고하셔서 정보 수집을 해주시기 바랍니다.<br><br>참고문서:<br>How to troubleshoot NTP issues<br>https://access.redhat.com/solutions/64868<br><br>본 케이스는 먼저 처리 완료 하겠습니다.<br><br>감사합니다. 즐거운 하루 되세요~<br><br><publishedDate>2018-05-30T05:44:21Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000MgLHDIA3"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-05-30T04:50:12Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-05-30T04:50:12Z</b><br><br>답변감사합니다.<br><br>해당 내용을 전달하였고.<br>모니터링 후에 동일한 증상이 발생하면 추가 케이스 오픈하겠습니다.<br>감사합니다.<br><br><publishedDate>2018-05-30T04:50:12Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000Mg3KOIAZ"><br>======================<br><b>생성계정 : Huang, Ying</b><br><b>생성날짜 : 2018-05-29T07:35:21Z</b><br><b>마지막 답변자 : Huang, Ying</b><br><b>마지막 수정 일자 : 2018-05-29T07:35:21Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>기존 사례에 의하면 2개의 ntp 서버를 사용시 시간 동기화가 되지 않는 이슈가 종종 있습니다.<br>ntp 서버는 4개 혹은 1개로 설정하시는것을 권장 드립니다.<br>반드시 2개의 ntp 서버를 사용하셔야 한다면 고객님께 권장하신바와 같이 true 옵션을 사용하셔야 합니다.<br>참고로 원인이 파악되지 않으나 해당 옵션 추가시에도 신뢰하는 클록소스를 선택하지 못하여 동기화가 실패되는 사례가 있습니다.<br><br>&gt; May 27 10:37:49 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0648 08 no_sys_peer <br><br>상기 메시지는 일시적으로 신뢰하는 클록소스를 선택하지 못할 경우에 출력됩니다. 영문 설명은 아래와 같습니다.<br>참고하시기 바랍니다.<br><br>The message is logged when the source selection doesn't have any selectable source (for that short period, till it reselect sources again). After clock step all sources need to collect new samples, trust them again and reselect them.<br><br>감사합니다.<br><br><publishedDate>2018-05-29T07:35:21Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Mg1OEIAZ"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-05-29T04:27:26Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-05-29T04:27:26Z</b><br><br>답변감사합니다.<br>현재도 간헐적으로 발생하고 있습니다.<br>물론 NTP서버와의 동기화는 정상적으로 진행되는 부분으로 확인됩니다.<br>아래의 부분을 해소하기 위해서<br>1. vi /etc/ntp.conf<br>[변경전]<br>..생략..<br>server 100.254.147.100 prefer<br>restrict 100.254.147.100 mask 255.255.255.255 nomodify notrap noquery<br>server 100.254.147.200<br>restrict 100.254.147.200 mask 255.255.255.255 nomodify notrap noquery<br>​[변경후]<br>..생략..<br>server 100.254.147.100 true<br>restrict 100.254.147.100 mask 255.255.255.255 nomodify notrap noquery<br>server 100.254.147.200<br>restrict 100.254.147.200 mask 255.255.255.255 nomodify notrap noquery​<br>​<br>2. vi /etc/sysconfig/ntpd <br>[변경전]<br>OPTIONS=&quot;-x -u ntp:ntp -p /var/run/ntpd.pid -g&quot;<br>[변경후]<br>OPTIONS=&quot;-g -4 -x&quot;<br>​<br>3. vi /etc/ntp/step-tickers<br>[변경전]<br># List of servers used for initial synchronization.<br>[변경후]<br># List of servers used for initial synchronization.​<br>100.254.147.100<br>​<br>4. vi /etc/sysconfig/ntpdate<br>[변경전]<br># Options for ntpdate<br>OPTIONS=&quot;-U ntp -s -b&quot;<br>​<br># Number of retries before giving up<br>RETRIES=2<br>​<br># Set to 'yes' to sync hw clock after successful ntpdate<br>SYNC_HWCLOCK=no<br>​[변경후]<br># Options for ntpdate<br>OPTIONS=&quot;-p 2 -4&quot;<br>​<br># Number of retries before giving up<br>RETRIES=2<br>​<br># Set to 'yes' to sync hw clock after successful ntpdate<br>SYNC_HWCLOCK=yes​<br>​<br>-&gt;모든 설정 변경후<br>하드웨어 시간 확인<br># hwclock <br>​<br>시스템 시간 확인<br># date<br>​<br>시간동기화​<br># service ntpd stop<br># ntpdate XXX.YYY.30.16<br># hwclock -w<br># service ntpd start<br>같이 가이드를 하였습니다만, 위의 방법으로 해결될지는 의문이네요.<br><br>그리고<br>May 27 10:37:49 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0648 08 no_sys_peer 메시지는 어떠한 이유로 발생하는지 확인 부탁드립니다.<br><br>추가적으로 <br>NTP 클라이언트와 NTP서버간에 통신이 UDP로 통신하는 것으로 알고 있는데요<br>해당 포트가 정상적으로 통신 되는지에 대해서 확인 할수 있는 방법이 있나요??<br>예를들면<br>telnet 명령어라든가 nc명령어로 확인할 수 있는 방법을 부탁드립니다.<br><br><publishedDate>2018-05-29T04:27:26Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000Mg13uIAB"><br>======================<br><b>생성계정 : Huang, Ying</b><br><b>생성날짜 : 2018-05-29T03:37:20Z</b><br><b>마지막 답변자 : Huang, Ying</b><br><b>마지막 수정 일자 : 2018-05-29T03:37:20Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>NTP는 서버와 클라이언트가 협상하여 버전을 사용하며 레드햇 NTP는 디폴트로 4버전을 사용합니다.<br>NTP 버전은 패킷 캡쳐로 확인되며 클라이언트에서는 확인 방법이 확인되지 않고 있습니다.<br><br>현재 이슈가 지속적으로 발생되고 있는것 인지요?<br>맞다면 NTP 서버를 한개로 변경하신후 NTP 서비스를 재기동 해주시기 이슈가 재현되는지 확인 부탁 드립니다.<br><br>감사합니다.<br><br><publishedDate>2018-05-29T03:37:20Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Mg00LIAR"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-05-29T00:41:36Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-05-29T00:41:36Z</b><br><br>추가 내용 문의드립니다.<br>NTP가 안되는 현상에 대해서 네트워크에 문의하였더니 아래와 같은 패킷 상황을 보내주었습니다.<br>업무에 참고 부탁드립니다.<br><br><publishedDate>2018-05-29T00:41:36Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000MfzvVIAR"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-05-29T00:27:13Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-05-29T00:27:13Z</b><br><br>답변감사합니다. <br>안녕하세요.<br>주말중 NTP 패치를 ntp-4.2.6p5-12.el6_9.2.x86_64 로 진행하였는데요. 현재 서버에서  지속적으로<br>May 27 10:00:42 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0618 08 no_sys_peer<br>May 27 10:07:15 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0628 08 no_sys_peer<br>May 27 10:17:02 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0638 08 no_sys_peer<br>May 27 10:37:49 SLPFMSAL01 ntpd[2984]: 0.0.0.0 0648 08 no_sys_peer<br>발생하며 <br>NTP서버와 시가차이도 크게 발생하는 현상이 발생하였습니다.<br><br>해당 원인이 NTP 업데이트 후에 발생한 상황인지는 확인이 되지는 않으나<br>대략 시점이 업데이트 후로 예상됩니다.<br><br>해당 이슈가 발생하여 서비스가 정상적으로 진행되지 않는 상황이 발생하였고 <br>삼성내에서 큰 이슈로 진행되고 있으니 빠른 진행 부탁드립니다.<br><br><br>추가적으로<br>네워크팀에 문의해보니 통신이 되지 않는 서버의 경우<br>NTP 버전3 이고 되는 서버의 경우 NTP 버전 4라고 하는데 <br>NTP버전은 어떻게 확인 하는지 회신 부탁드립니다.<br><br><br>==============================================================================<br>* 고객 정보 (필수) - 실제 레드햇 서브스크립션을 소유하고 시스템에 사용 중인 엔드 유저<br>- 성함(직급) : 김태현 (책임)<br>- 회사명(부서명) : 삼성SDS<br>- 전화번호 :  82-10-3734-0720<br>- 메일주소 : 김태현 &lt;th0720.kim@samsung.com&gt;<br><br>* 파트너 정보 (옵션) - 실제 고객의 시스템을 유지보수하는 업체<br>- 성함(직급) : 송기호(책임)<br>- 회사명(부서명) : 타임게이트(오픈소스팀)<br>- 전화번호 : 01036209917<br>- 메일주소 : kh.song@time-gate.com<br>==============================================================================<br><br><publishedDate>2018-05-29T00:27:13Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000MfoRqIAJ"><br>======================<br><b>생성계정 : Huang, Ying</b><br><b>생성날짜 : 2018-05-28T03:18:00Z</b><br><b>마지막 답변자 : Huang, Ying</b><br><b>마지막 수정 일자 : 2018-05-28T03:18:00Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>클라이언트와 서버와의 시간차이가 1000초 이상일 경우 시간 동기화를 포기하게 됩니다.<br><br>참고문서:<br>How to reduce the chance of time stepping caused by ntpd<br>https://access.redhat.com/solutions/34765<br><br>일반적으로 시간 sync가 되지 않는 이슈는 NTP 서버와의 연결이 불안정한 등 원인으로<br>신뢰되지 않는 시간소스로 판단하면 발생됩니다.<br><br>감사합니다.<br><br><publishedDate>2018-05-28T03:18:00Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>
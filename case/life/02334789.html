======================<br><b>생성계정 : JIMIN KIM</b><br><b>생성날짜 : 2019-03-11T08:43:22Z</b><br><b>마지막 답변자 : GSS Tools</b><br><b>마지막 수정 일자 : 2019-04-02T04:45:16Z</b><br><b>id : 5002K00000dOAvpQAG</b><br>======================<br><br><b><font size=15>
제목  : 파일시스템 생성 및 마운트 관련해서 문의
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하세요<br><br>SDS 김지민 선임입니다.<br><br>파일시스템 생성 및 마운트 관련해서 문의드리려고 합니다.<br><br>기존에 생성되어있는 파일시스템을 삭제 후 동일한 정보로 파일시스템을 생성하는 경우, <br>혹시 systemd 데몬에 의해 lvcreate 수행 시 파일시스템이 자동으로 마운트가 되는지 문의를 드리려고 합니다.<br><br>파일시스템 작업 시 기존 lvol과 사이즈만 변경하여 동일한 명칭으로 생성을 했는데<br>자동으로 마운트 되는 현상이 발생했어서 문의드립니다.<br><br>감사합니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>타입  : Other</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 3 (Normal)</b><br><hostname>PCONML01SL</hostname><br><br><br><comment id="a0a2K00000PXbHcQAL"><br>======================<br><b>생성계정 : Kim, Mahyun</b><br><b>생성날짜 : 2019-03-13T08:13:58Z</b><br><b>마지막 답변자 : Kim, Mahyun</b><br><b>마지막 수정 일자 : 2019-03-13T08:13:58Z</b><br><br>안녕하세요. Red Hat 김마현 차장입니다.<br><br>확인된 내용 업데이트 해드립니다.<br><br>umount -&gt; lvremove -&gt; lvcreate 시 mount 되는 현상에 대해서는 KCS 문서로는 확인되지 않지만 내부적으로 해외 case로는 확인되었습니다.<br><br>이런 현상은 systemd가 파일 시스템 마운트를 관리하기 때문에 발생되며,<br>systemd가 시작되면 /etc/fstab을 읽고 나열된 각 마운트에 대한 고유 한 systemd '마운트'단위를 생성하게 됩니다.<br><br>아래 명령을 통해 확인 가능합니다.<br># systemctl --all | grep \\.mount<br><br>그리고 systemd가 생성 한 장치는 장치가 생성 될 때마다, 논리 볼륨이 다시 생성 될 때마다 활성화(mount)됩니다.<br><br><br>아래는 제가 테스트 한 내용으로 lvcreate(recreate)시 자동 mount 현상이 발생됨을 확인하였습니다.<br><br># umount /mnt3<br><br># lvremove /dev/vg02/test3 <br>Do you really want to remove active logical volume vg02/test3? [y/n]: y<br>  Logical volume &quot;test3&quot; successfully removed <br><br># lvcreate -l330 -ntest3 vg02<br>WARNING: xfs signature detected on /dev/vg02/test3 at offset 0. Wipe it? [y/n]: y<br>  Wiping xfs signature on /dev/vg02/test3.<br>  Logical volume &quot;test3&quot; created.<br>--&gt; 만약 여기서 lv의 사이즈를 기존과 다르게 한게되면 mount를 시도하긴 하지만 변경점으로 인해 filesystem이 일치하지 않아 mount가 실패됩니다.<br><br>- 아래는 각 과정의 journalctl 로그입니다.<br>Mar 13 16:49:42 pcm01 kernel: XFS (dm-8): Unmounting Filesystem<br>Mar 13 16:50:01 pcm01 systemd[1]: Started Session 135 of user root.<br>Mar 13 16:50:01 pcm01 systemd[1]: Starting Session 135 of user root.<br><br>Mar 13 16:51:41 pcm01 multipathd[666]: dm-8: remove map (uevent)<br>Mar 13 16:51:41 pcm01 multipathd[666]: dm-8: devmap not registered, can't remove<br>Mar 13 16:51:41 pcm01 multipathd[666]: dm-8: remove map (uevent)<br><br>Mar 13 16:53:12 pcm01 systemd[1]: Found device /dev/mapper/vg02-test3.<br>Mar 13 16:53:12 pcm01 systemd[1]: Found device /dev/disk/by-id/dm-uuid-LVM-4MCRAAKHBqZmlY0gS8YMJR9a9TajJDfzLssvKEkBi1khLejqm1EGHXzl3rgtUMiV.<br>Mar 13 16:53:12 pcm01 systemd[1]: Found device /dev/disk/by-id/dm-name-vg02-test3.<br>Mar 13 16:53:12 pcm01 systemd[1]: Found device /dev/dm-8.<br>Mar 13 16:53:12 pcm01 systemd[1]: Found device /sys/devices/virtual/block/dm-8.<br>Mar 13 16:53:12 pcm01 systemd[1]: Mounting /mnt3...<br>Mar 13 16:53:12 pcm01 kernel: XFS (dm-8): Mounting V5 Filesystem<br>Mar 13 16:53:12 pcm01 kernel: XFS (dm-8): Ending clean mount<br>Mar 13 16:53:12 pcm01 systemd[1]: Mounted /mnt3.<br><br><br>이러한 현상은 systemd를 사용하는 RHEL 7에서는 정상적인 현상이지만<br>상황에 따라서는 사전에 운영자가 mount를 인지하지 못 했을 때 문제가 될 수 있습니다.<br>따라서 vgchange, lvcreate(recreate) 작업 시 기존과 같은 장애를 방지하기 위해서는<br>사전에 systemctl mask 처리 방법을 통해 자동 mount 방지 작업이 필요하고,<br>작업이 끝나고 수동으로 마운트 후 unmask 처리를 해야할 것 입니다.<br><br>감사합니다.<br>김마현 드림.<br><br><publishedDate>2019-03-13T08:13:58Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PXKGqQAP"><br>======================<br><b>생성계정 : KIM, JIMIN</b><br><b>생성날짜 : 2019-03-12T11:21:45Z</b><br><b>마지막 답변자 : KIM, JIMIN</b><br><b>마지막 수정 일자 : 2019-03-12T11:21:44Z</b><br><br>안녕하세요<br><br>SDS 김지민 선임입니다.<br><br>문제 상황 시점에 작업은 로그는 없지만<br><br>umount → lvremove → lvcreate 까지만 하였는데 auto mount가 된 것으로 전달 받았습니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-12T11:21:44Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PXExCQAX"><br>======================<br><b>생성계정 : Kim, Mahyun</b><br><b>생성날짜 : 2019-03-12T05:06:50Z</b><br><b>마지막 답변자 : Kim, Mahyun</b><br><b>마지막 수정 일자 : 2019-03-12T05:06:50Z</b><br><br>안녕하세요. Red Hat 김마현입니다.<br><br>조금 전 유선상으로 얘기 나눈것처럼,<br>vg 레이어 단의 작업이 아닌 lv 레이어 단의 lv vol 작업에 대해서도 auto mount가 해당되는지 확인 후 내용 업데이트 해드리겠습니다.<br><br>김지민 선임님께서는 기존 이슈(18/12/16 작업때)에 대한 자세한 내역 확인 부탁드립니다.<br><br>감사합니다.<br>김마현 드림.<br><br><publishedDate>2019-03-12T05:06:50Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PXDYOQA5"><br>======================<br><b>생성계정 : Kim, Mahyun</b><br><b>생성날짜 : 2019-03-12T02:13:17Z</b><br><b>마지막 답변자 : Kim, Mahyun</b><br><b>마지막 수정 일자 : 2019-03-12T02:13:17Z</b><br><br>안녕하세요. Red Hat 김마현입니다.<br><br>관련하여 확인된 내용 업데이트 해드립니다.<br><br>언급하신 내용은 vg가 active 될 때 /etc/fstab의 값을 참조하여 system.d에 의해 자동으로 마운트 되는 현상입니다.<br>RHEL 7은 systemd가 이 부분을 컨트롤하는 관계로 RHEL 6와 다르게 동작을 합니다.<br>따라서 주의가 필요한 부분이고 언급하신대로 작업에 따라 mask 설정이 필요할 수 있습니다.<br><br>- 3번 과정에서 auto mount가 이루어 집니다.<br>1) vgchange -a n VG<br>2) 볼륨작업<br>3) vgchange -a y VG <br><br>- RHEL 7에서 auto mount를 방지하는 방법은 크게 2가지가 있습니다.<br>1. systemctl mask 처리<br>   (관련 KCS 문서 : https://access.redhat.com/solutions/3059631)<br><br>2. fatab 설정<br>   - /etc/fstab의 해당 볼륨의 마운트 부분을 임시로 주석처리 또는 noauto 옵션 적용 -&gt; umount 볼륨 -&gt; systemctl daemon-reload<br><br>* KCS 문서의 내용 처럼 1번 방법을 권장드립니다.<br>* 참고로 vgchange 에서 automount가 되지 않도록 하는 옵션을 확인해 보았지만 확인되지 않습니다.<br><br><br>아래는 systemctl mask 처리 방법으로 테스트 진행한 내용입니다. 참고하십시오.<br>1) test lvm 볼륨 - /mnt 정보 확인<br>[root@pcm01 ~]# cat /etc/fstab | grep mnt<br>/dev/vg01/lv01          /mnt                    xfs     defaults        0 0<br><br>[root@pcm01 ~]# mount | grep /mnt<br>/dev/mapper/vg01-lv01 on /mnt type xfs (rw,relatime,attr2,inode64,noquota)<br><br>2) umount /mnt<br>[root@pcm01 ~]# umount /mnt<br><br>3) /mnt 볼륨 mask<br>[root@pcm01 ~]# systemctl mask mnt.mount<br>Created symlink from /etc/systemd/system/mnt.mount to /dev/null.<br><br>4) masked 확인<br>[root@pcm01 ~]# systemctl --all | grep \\.mount | grep mnt.mount<br>● mnt.mount                                       masked    inactive dead      mnt.mount<br><br>5) vg inactive 설정<br>[root@pcm01 ~]# vgchange -an vg01<br><br>6) vg active 설정<br>[root@pcm01 ~]# vgchange -ay vg01<br><br>7) /mnt 볼륨 마운트 확인<br>[root@pcm01 ~]# mount | grep /mnt<br>-&gt; 마운트 안됨<br><br>8) /mnt 볼륨 수동으로 마운트<br>[root@pcm01 ~]# mount /mnt<br><br>9) /mnt 볼륨 unmask (unmask를 하지 않으면 부팅 시 /mnt 볼륨이 mount가 되지 않음)<br>[root@pcm01 ~]# systemctl unmask mnt.mount<br>Removed symlink /etc/systemd/system/mnt.mount.<br><br>10) /mnt 볼륨 loaded 상태 확인<br>[root@pcm01 ~]# systemctl --all | grep \\.mount | grep mnt.mount<br># systemctl --all | grep \\.mount | grep mnt.mount<br>  mnt.mount                                       loaded    active   mounted   /mnt<br><br><br>* 추가적으로 xfs 파일시스템은 reduce(축소)가 되지 않는점 참고하시기 바랍니다.<br>아래는 관련 KCS 문서입니다.<br>https://access.redhat.com/solutions/540013<br><br><publishedDate>2019-03-12T02:13:17Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PXChfQAH"><br>======================<br><b>생성계정 : KIM, JIMIN</b><br><b>생성날짜 : 2019-03-12T00:37:00Z</b><br><b>마지막 답변자 : KIM, JIMIN</b><br><b>마지막 수정 일자 : 2019-03-12T00:37:00Z</b><br><br>안녕하세요<br><br>SDS 김지민 선임입니다.<br><br>위의 문의를 드리게 된 사유는 SDS 센터에서 아래와 같은 장애가 발생하였었는데요.<br>실제로 아래와 같은 현상이 발생하고 파일시스템 작업 시 systemd까지 umask하면서 작업을 해야하는지 문의드리려고 하였습니다.<br><br>○ 장애 원인 <br>- F/S(TEMP01) 용량 축소를 위한 F/S 재생성(‘18/12/16)작업시 mkfs 수행하기 전에 <br>  systemd 데몬이 F/S을 auto-mount 시키면서 metadata CRC error가 발생<br>- metadata CRC error 상태에서 운영되던 중 TEMP01 F/S에 I/O가 많았던 시점(2/11 17시경)에 <br>  장애 발생<br>○ 발생 조건<br>- 旣생성된 F/S 을 삭제(lvremove) 후 동일한 정보로 F/S을 생성하는 경우, systemd 데몬에 의해 <br>  lvcreate 수행시 F/S이 자동으로 마운트됨(mkfs 수행 단계 이전에 mount)<br>○ 향후 방안<br>- 작업절차 보완(상기조건에 해당하는 작업수행시 systemd 데몬이 F/S 를 관리하지 못하도록 작업동안 mask 처리)<br>① systemctl --all | grep mount 에서 &quot;FS&quot;.mount 정보 확인<br>② systemctl mask &quot;FS&quot;.mount<br>③ lvremove -&gt; lvcreate , LV 재생성작업 수행(mkfs, mount)<br>④ systemctl unmask “FS”.mount<br><br>감사합니다.<br><br><publishedDate>2019-03-12T00:37:00Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PXCfjQAH"><br>======================<br><b>생성계정 : Kim, Mahyun</b><br><b>생성날짜 : 2019-03-12T00:29:28Z</b><br><b>마지막 답변자 : Kim, Mahyun</b><br><b>마지막 수정 일자 : 2019-03-12T00:29:28Z</b><br><br>안녕하세요. Red Hat 김마현입니다.<br><br>문의주신 내용 확인하여 업데이트 하도록 하겠습니다.<br><br>감사합니다.<br>김마현 드림.<br><br><publishedDate>2019-03-12T00:29:28Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>
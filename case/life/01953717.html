======================<br><b>생성계정 : 타임게이트 (주)</b><br><b>생성날짜 : 2017-10-17T05:55:25Z</b><br><b>마지막 답변자 : Min Woo Park</b><br><b>마지막 수정 일자 : 2017-10-19T05:17:07Z</b><br><b>id : 500A000000YTX6vIAH</b><br>======================<br><br><b><font size=15>
제목  : [삼성생명] 번들 http server 설정문의(mod_proxy)
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하세요, 기 문의드린 mod_proxy 관련하여 재 문의드립니다. <br>## 고객정보 ## <br>고객사 : 삼성생명<br>고객명 : 박현우 선임<br>연락처 : 010-9104-2853<br>##<br><br>## 환경정보 ##<br>OS : RHEL 7.2<br>web : bundle http server 2.4.x<br>이전 SR 진행번호 : 기술 문의 01938049<br>##<br>현재 mod_proxy 설정은 하기와 같습니다. <br>##<br>&lt;VirtualHost xx.xx.xx.xx:8080&gt;<br>DocumentRoot &quot;/APP/ep/webdocs&quot;<br>ServerName ep.ap.p.samsunglife.kr:8080<br>DirectoryIndex index.jsp<br>ErrorLog &quot;|/usr/sbin/rotatelogs /LOG/ep/apache/error/error_ep_log_%Y_%m_%d 86400&quot;<br>CustomLog &quot;|/usr/sbin/rotatelogs /LOG/ep/apache/access/access_ep_log_%Y_%m_%d 86400&quot; combined env=!etc<br>ProxyRequests on<br>ProxyVia on<br>Header add Set-Cookie &quot;ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/&quot; env=BALANCER_ROUTE_CHANGED<br>   <br>&lt;Proxy balancer://epCluster&gt;<br>BalancerMember http://ep.ap1.p.samsunglife.kr:50000 route=ep1<br>BalancerMember http://ep.ap2.p.samsunglife.kr:50000 route=ep2<br>BalancerMember http://ep.ap3.p.samsunglife.kr:50000 route=ep3<br>BalancerMember http://ep.ap1.p.samsunglife.kr:51000 route=ep9<br>BalancerMember http://ep.ap2.p.samsunglife.kr:51000 route=ep10<br>BalancerMember http://ep.ap3.p.samsunglife.kr:51000 route=ep11<br>ProxySet stickysession=ROUTEID<br>&lt;/Proxy&gt;<br>## 중략 ##<br>ProxyPass /balancer-manager !<br>ProxyPass /server-status !<br>ProxyPass &quot;/&quot; &quot;balancer://epCluster/&quot;<br>ProxyPassReverse &quot;/&quot; &quot;balancer://epCluster/&quot;<br>ProxyPreserveHost On<br>## 중략 ##<br>&lt;/VirtualHost&gt;<br>##<br>1.  mod_proxy를 설정할 경우 keepalive에 대하여 명시적인 설정이 없을 경우 default 값은 어떻게 되는지요?<br>--&gt; 하기 URL의 Worker|BalancerMember parameters 항목을 보면 keepalive<br>Off(default)로 되어있고 저희가 Proxy 내에서  BalancerMember http://ep.ap1.p.samsunglife.kr:50000 route=ep1 등으로 설정하여 문의드립니다. <br>This parameter should be used when you have a firewall between your Apache httpd and the backend server, which tends to drop inactive connections. This flag will tell the Operating System to send KEEP_ALIVE messages on inactive connections and thus prevent the firewall from dropping the connection. To enable keepalive, set this property value to On.<br><br>The frequency of initial and subsequent TCP keepalive probes depends on global OS settings, and may be as high as 2 hours. To be useful, the frequency configured in the OS must be smaller than the threshold used by the firewall.<br>참고 URL : https://httpd.apache.org/docs/2.4/mod/mod_proxy.html<br><br>문의2. keepalive가 on(enable) 되어 있는 경우 명시적인 설정이 없을 때 keepalivetimeout의 값은 몇초인지요?<br>httpd.conf 상 설정은 하기와 같이 되어 있는데 ProxyTimeout와 같이  옵션이 별도 존재하는 지요?<br>##<br>KeepAlive On<br>MaxKeepAliveRequests 1000<br>KeepAliveTimeout 15<br>##<br>문의3. 기 SR에서 keepalive&amp;pool을 disable 하기위해 하기와 같이 가이드 주셨는데 1의 의미가 무엇인지요? 추가로 설정할 수 있는 옵션들이 어떤 것들이 있는지요?(예, -1, 0, 1 등)<br>&lt;Proxy&gt;<br>SetEnv proxy-nokeepalive 1<br>SetEnv proxy-initial-not-pooled 1<br>&lt;/Proxy&gt;<br><br>감사합니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>타입  : Other</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 3 (Normal)</b><br><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0aA000000KmJrzIAF"><br>======================<br><b>생성계정 : Park, Min Woo</b><br><b>생성날짜 : 2017-10-19T05:17:07Z</b><br><b>마지막 답변자 : Park, Min Woo</b><br><b>마지막 수정 일자 : 2017-10-19T05:17:06Z</b><br><br>안녕하세요,  <br>      <br>요청대로 본 케이스를 처리완료하도록 하겠습니다. 만약 본 케이스와 관련하여 추가 질문이 있으시다면 언제든지 재오픈하실 수 있습니다.  <br>     <br>케이스가 처리 완료되면 가능하게 고객 설문조사 메일이 발생됩니다. 고객님께서 남기 신 의견은 보다 나은 서비스를 위해 지속적으로 반영될 것입니다. 향후 기술  지원 서비스의 품질 향상을 위해, 소중한 시간을 내어 주시면 대단히 감사드리겠습니다. <br><br>그리고 아래 Red Hat Customer Portal group을 통하여 많은 유용한 정보들을 볼수 있으니 참고하시기 바랍니다.<br><br>Featured Groups:<br>Red Hat Enterprise Linux - https://access.redhat.com/groups/red-hat-enterprise-linux<br>Red Hat Enterprise Linux 7 Ideas - https://access.redhat.com/groups/red-hat-enterprise-linux-7-ideas<br>Red Hat Enterprise Linux Developer Program (beta) - https://access.redhat.com/groups/red-hat-enterprise-linux-developer-program-beta<br>Red Hat Enterprise Virtualization - https://access.redhat.com/groups/red-hat-enterprise-virtualization<br>Red Hat Storage - https://access.redhat.com/groups/red-hat-storage<br>JBoss Enterprise Middleware - https://access.redhat.com/groups/jboss-enterprise-middleware<br>Red Hat Network Satellite - https://access.redhat.com/groups/red-hat-network-satellite<br>       <br>감사합니다.<br><br><publishedDate>2017-10-19T05:17:06Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000KmJl9IAF"><br>======================<br><b>생성계정 : (주), 타임게이트</b><br><b>생성날짜 : 2017-10-19T05:07:13Z</b><br><b>마지막 답변자 : (주), 타임게이트</b><br><b>마지막 수정 일자 : 2017-10-19T05:07:13Z</b><br><br>빠른 확인 감사드립니다. <br>SR 종료합니다. <br>감사합니다.<br><br><publishedDate>2017-10-19T05:07:13Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000KhscxIAB"><br>======================<br><b>생성계정 : Park, Min Woo</b><br><b>생성날짜 : 2017-10-18T08:28:55Z</b><br><b>마지막 답변자 : Park, Min Woo</b><br><b>마지막 수정 일자 : 2017-10-18T08:28:54Z</b><br><br>안녕하세요,<br><br>apache community 사이트 확인 중 proxy를 이용한 web-was connnection 시 하기의 옵션으로 connection timeout을 설정할 수 있는 것으로 보이는데 명시적 설정이 없다면 몇 초인지 확인요청드립니다. <br>==&gt;<br>doc [1]에서 보신것과 같이 connectiontimeout의 default는 timeout 값이며, 동일 doc의 timeout의 default는 ProxyTimeout 입니다.<br>ProxyTimeout의 default는 doc [2]에서 보시는 것처럼 'Default:<br>Value of Timeout', 즉 global Timeout 값입니다.<br><br><br>만약 하기와 같이 설정하였다면 5초 주기로 2번 connection을 재시도하여 응답이 없으면 web-was 간 연동이 안되어 Timeout이 발생하는 건지  확인요청드립니다.<br>==&gt;<br>doc [1]에서 보시는 것처럼 retry의 정의는 아래와 같습니다.<br>~~~~~<br>Connection pool worker retry timeout in seconds. If the connection pool worker to the backend server is in the error state, Apache httpd will not forward any requests to that server until the timeout expires.<br>~~~~~<br><br>백엔드 서버로의 connection pool worker가 error state 일 경우, 'retry' 시간동안 request를 보내지 않습니다.<br>따라서 'connectiontimeout=10 retry=5' 인 경우, 백앤드 서버가 계속해서 응답을 못주는 상황이라면 2번(각 5초 timeout) 시도한 후 connectiontimeout이 발생되겠습니다.<br><br>감사합니다.<br><br>[1] https://httpd.apache.org/docs/2.4/en/mod/mod_proxy.html#balancermember<br>[2] https://httpd.apache.org/docs/current/mod/mod_proxy.html#proxytimeout<br><br><publishedDate>2017-10-18T08:28:54Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000KhrEwIAJ"><br>======================<br><b>생성계정 : (주), 타임게이트</b><br><b>생성날짜 : 2017-10-18T06:05:25Z</b><br><b>마지막 답변자 : (주), 타임게이트</b><br><b>마지막 수정 일자 : 2017-10-18T06:05:25Z</b><br><br>안녕하세요 빠른 답변에 감사드립니다. <br>추가 문의사항이 있어 SR 업데이트 드립니다. <br><br>기 알고계신 것과 같이 mod_proxy를 연동하여 Proxy 탭의 BalancerMeber로 각 ap node를 명시하여 서비스 중에 있습니다. <br><br>apache community 사이트 확인 중 proxy를 이용한 web-was connnection 시 하기의 옵션으로 connection timeout을 설정할 수 있는 것으로 보이는데 명시적 설정이 없다면 몇 초인지 확인요청드립니다. <br>connectiontimeout<br>timeout(default)<br>- Connect timeout in seconds. The number of seconds Apache httpd waits for the creation of a connection to the backend to complete<br>참고 URL : https://httpd.apache.org/docs/2.4/en/mod/mod_proxy.html#balancermember<br><br>또한 만약 하기와 같이 설정하였다면 5초 주기로 2번 connection을 재시도하여 응답이 없으면 web-was 간 연동이 안되어 Timeout이 발생하는 건지  확인요청드립니다. <br>##<br>&lt;Proxy balancer://iiscluster/&gt;<br>  Header add Set-Cookie &quot;ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/&quot; env=BALANCER_ROUTE_CHANGED<br>  BalancerMember https://192.168.0.1 loadfactor=1 connectiontimeout=10 retry=5 route=node1<br>  BalancerMember https://192.168.0.2 loadfactor=1 connectiontimeout=10 retry=5 route=node2<br>&lt;/Proxy&gt;<br>##<br><br>감사합니다.<br><br><publishedDate>2017-10-18T06:05:25Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000Khq8gIAB"><br>======================<br><b>생성계정 : Park, Min Woo</b><br><b>생성날짜 : 2017-10-18T02:48:39Z</b><br><b>마지막 답변자 : Park, Min Woo</b><br><b>마지막 수정 일자 : 2017-10-18T05:02:18Z</b><br><br>안녕하세요,<br><br>mod_proxy_http 모듈은 [1]에 정의된 것처럼 'HTTP support module for mod_proxy' 입니다.<br><br>예를 들어 http/https 로 통신을 하는 경우에는 mod_proxy, mod_proxy_http 모듈이 필요(로딩되어야)하고,<br>ajp로 통신을 하는 경우에는 mod_proxy, mod_proxy_ajp 모듈이 필요합니다.<br>마찬가지로 Proxy balancer 기능을 사용하시려면 mod_proxy_balancer 모듈이 필요합니다.<br><br>즉, mod_proxy를 사용한다는 의미가 mod_proxy.so만 사용한다는 것이 아니고, mod_proxy.so를 기본으로 추가적인 모듈들을 사용하는 것이라고 이해하시면 되겠습니다.<br>httpd 내부적으로 request 처리의 어느 부분을 mod_proxy를 사용하고, 어느 부분을 mod_proxy_http를 사용하는지 자세한 사항까지는 알 수가 없습니다.<br><br>감사합니다.<br><br>[1] https://httpd.apache.org/docs/2.4/mod/mod_proxy_http.html<br><br><publishedDate>2017-10-18T02:48:38Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Khq1LIAR"><br>======================<br><b>생성계정 : (주), 타임게이트</b><br><b>생성날짜 : 2017-10-18T02:26:22Z</b><br><b>마지막 답변자 : (주), 타임게이트</b><br><b>마지막 수정 일자 : 2017-10-18T02:26:22Z</b><br><br>빠른 확인에 감사드립니다. <br><br>apache error log 에 하기의 태그로 로그가 적재되는 것이 확인되는데<br>mod_proxy와  mod_proxy_http의 차이가 존재하는지요?<br>동일 referer에서 요청된 request인 것으로 판단되는데 하기와 같이 상이하여 문의드립니다. <br>[proxy_http:error] <br>[proxy:error]<br><br>##관련 로그 ##<br>[Thu Oct 12 10:50:48.104548 2017] [proxy_http:error] [pid 551:tid 140277943211776] (70014)End of file found: [client 112.219.241.123:21398] AH01102: error reading status line from remote server ep.ap20.p.samsunglife.kr:51031, referer: https://erp-ep.samsunglife.com/irj/servlet/prt/portal/prtroot/request.Dispatcher?type=UI5_PAGE&amp;id=PGEPQL00100&amp;IS_POPUP=true<br>[Thu Oct 12 10:50:48.104561 2017] [proxy:error] [pid 551:tid 140277943211776] [client 112.219.241.123:21398] AH00898: Error reading from remote server returned by /portal/dataService.do, referer: https://erp-ep.samsunglife.com/irj/servlet/prt/portal/prtroot/request.Dispatcher?type=UI5_PAGE&amp;id=PGEPQL00100&amp;IS_POPUP=true<br>##<br><br>감사합니다.<br><br><publishedDate>2017-10-18T02:26:22Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000KhbLrIAJ"><br>======================<br><b>생성계정 : Park, Min Woo</b><br><b>생성날짜 : 2017-10-17T07:58:41Z</b><br><b>마지막 답변자 : Park, Min Woo</b><br><b>마지막 수정 일자 : 2017-10-17T07:58:41Z</b><br><br>안녕하세요,  <br>  <br>Red Hat Global Support Services를 이용해주셔서 감사합니다.  <br><br>mod_proxy 에서 &quot;keepalive&quot;라는 것에는 2가지 의미가 있습니다.<br><br>하나는 keepalive connection(=connection pooling) 이고, 또다른 하나는 tcp keepalive flag(sending a tcp packet periodically to check the peer) 입니다.<br><br>mod_proxy 관련 apache doc [1]의 Worker|BalancerMember parameters 항목의 'keepalive'는 tcp keepalive flag를 의미하며 default로는 Off 입니다.<br>만약 On으로 tcp keepalive flag를 사용한다면, 이에 대한 frequency(not timeout)는 doc [1]에 정의된대로 global OS settings을 따라가게 됩니다.<br><br>mod_proxy는 기본적으로(default로) connection pooling feature를 가지고 있습니다.<br>즉, mod_proxy는 디폴트로 우리가 일반적으로 생각하는 keepalive connection(=connection pooling)을 사용하며 이에 대한 timeout은 디폴트로 no timeout 입니다.<br>doc [1]에 정의된 ttl 값을 timeout처럼 설정할 수 있는데 (ttl - Time to live for inactive connections and associated connection pool entries, in seconds. Once reaching this limit, a connection will not be used again; it will be closed at some later time.), <br>한가지 주목해야 할 부분은 ttl로 설정된 시간이 초과되었을 경우 keepalive connection 자체를 close 하는 것이 아니고, reuse를 안하는 것입니다.<br>실제 connection은 새로운 request가 들어왔을때 httpd child process에서 pooled connection을 체크하면서 ttl 이상이 된 connection에 대해 close를 하게 됩니다.<br><br>다시 정리하자면, mod_proxy 사용시 디폴트로 timeout이 없는 keepalive connection 을 사용하게 되며,<br>이를 disable 하기 위해서는 이전 case에 설명드린 것처럼 아래의 설정을 해주시면 됩니다.<br>~~~~~<br>SetEnv proxy-nokeepalive 1<br>SetEnv proxy-initial-not-pooled 1<br>~~~~~<br>1의 의미는 'turn on'의 의미이며, 보통 'turn on' 설정을 위해서만 'SetEnv ... 1 과 같이 설정을 하게 됩니다. 다른 설정값은 없습니다.<br><br>추가로, global 변수인 'KeepAlive', 'KeepAliveTimeout'는 client - web 사이의 connection에 대한 keepalive 내용으로써 mod_proxy의 keepalive connection과는 무관합니다.<br><br>감사합니다. <br>Minwoo Park  <br><br>[1] https://httpd.apache.org/docs/2.4/mod/mod_proxy.html<br><br><publishedDate>2017-10-17T07:58:41Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000KhZy2IAF"><br>======================<br><b>생성계정 : (주), 타임게이트</b><br><b>생성날짜 : 2017-10-17T05:58:10Z</b><br><b>마지막 답변자 : (주), 타임게이트</b><br><b>마지막 수정 일자 : 2017-10-17T05:58:10Z</b><br><br>문의2에 대하여 추가로 설명드립니다. <br>설정 상 ProxyTimeout가 명시적으로 선언되어 있지 않을 경우 기본 Timeout 600(초) 가 적용되는 것처럼<br>mod_proxy를 위한 별도의 keepalivetimeout이 명시적으로 선언되어 있지 않는 경우 현재 KeepAliveTimeout인 15초가 적용되는 것인지 궁금합니다.<br><br><publishedDate>2017-10-17T05:58:10Z</publishedDate><createdByType>Customer</createdByType><br>======================<br></comments><br>
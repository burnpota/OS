======================<br><b>생성계정 : 타임게이트 타임게이트</b><br><b>생성날짜 : 2018-10-31T09:09:27Z</b><br><b>마지막 답변자 : 타임게이트 타임게이트</b><br><b>마지막 수정 일자 : 2018-11-15T04:46:36Z</b><br><b>id : 500A000000cSB7nIAG</b><br>======================<br><br><b><font size=15>
제목  : cluster 페일오버 에러 확인
</font></b><br><br>======================<br><b>사전문의<br></b><br>2018년 10월 26일 Oct 26 15:10:27 경에 운영중이 클러스터가 페일오버가 되었습니다.<br>해당 문제는 운영중이던 리소스가 동작하고 있지 않아서 발생한 문제로 보고 있으나<br>그외 OS 측면에서 다른 원인이 있나 확인하고 싶습니다.<br><br>실제 클러스터가 동작한 과정은 다음과  같습니다.<br><br><br>리소스로 등록된 프로세스가 아래와 같이 동작하지 않은 로그가 발견되었습니다.<br><br>Oct 26 15:10:27 SLPCTIDL01 crmd[17038]:  notice: SLPCTIDL01-HB-CTI_script_monitor_60000:1132 [ CTI-CUBE Not running\n ]<br><br>이에 클러스터가 페일오버 과정을 진행하였습니다.<br>1호기 stopping<br><br>Oct 26 15:10:27 SLPCTIDL01 logger: stopping CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/shutdown.sh'<br>Oct 26 15:10:32 SLPCTIDL01 logger: stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop'<br>Oct 26 15:10:38 SLPCTIDL01 logger: starting CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstart'<br>Oct 26 15:10:46 SLPCTIDL01 logger: starting CTI-tomcat  'su - ctibg1 -c /cube/apache-to:ㅌ<br>mcat/bin/startup.sh'<br>Oct 26 15:11:43 SLPCTIDL01 logger: stopping CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/shutdown.sh'<br>Oct 26 15:11:46 SLPCTIDL01 logger: stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop'<br>Oct 26 15:11:53 SLPCTIDL01 logger: starting CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstart'<br>Oct 26 15:12:00 SLPCTIDL01 logger: starting CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/startup.sh'<br>Oct 26 15:16:58 SLPCTIDL01 logger: stopping CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/shutdown.sh'<br>Oct 26 15:17:01 SLPCTIDL01 logger: stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop'<br><br><br>2호기 starting<br><br>Oct 26 15:18:52 SLPCTIDL02 logger: starting CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstart'<br>Oct 26 15:19:01 SLPCTIDL02 logger: starting CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/startup.sh'<br><br><br>2호기 stopping<br><br>이후 <br>notice: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired<br>메세지와 함께 클러스터가 1호기로 이동하였습니다.<br>======================<br>Oct 26 15:24:04 SLPCTIDL02 logger: stopping CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/shutdown.sh'<br>Oct 26 15:24:07 SLPCTIDL02 logger: stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop'<br><br>1호기 starting<br><br>Oct 26 15:25:54 SLPCTIDL01 logger: starting CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstart'<br>Oct 26 15:26:02 SLPCTIDL01 logger: starting CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/startup.sh'<br><br><br>1호기 stop<br>마찬가지로 Oct 26 16:27:01 SLPCTIDL01 crmd[17038]:  notice: SLPCTIDL01-HB-CTI_script_monitor_60000:1208 [ CTI-CUBE Not running\n ]<br><br>모니터링 중인 프로세스가 감지되어 <br><br>Oct 26 16:27:01 SLPCTIDL01 logger: stopping CTI-tomcat  'su - ctibg1 -c /cube/apache-tomcat/bin/shutdown.sh'<br>Oct 26 16:27:05 SLPCTIDL01 logger: stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop'<br><br>1호기 리부팅<br><br>Oct 26 16:29:24 SLPCTIDL01 systemd-logind: Power key pressed.<br>Oct 26 16:29:24 SLPCTIDL01 systemd-logind: Powering Off...<br>Oct 26 16:29:24 SLPCTIDL01 systemd-logind: System is powering down.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.4</b><br><b>타입  : Other</b><br><b>계정 번호  : 1648604</b><br><b>심각도  : 3 (Normal)</b><br><hostname>SLPCTIDL01,SLPCTIDL02</hostname><br><br><br><comment id="a0aA000000O6nXaIAJ"><br>======================<br><b>생성계정 : Park, HyunYick</b><br><b>생성날짜 : 2018-11-05T08:36:01Z</b><br><b>마지막 답변자 : Park, HyunYick</b><br><b>마지막 수정 일자 : 2018-11-05T08:48:32Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>먼저 문의하신 내용에 대한 답변입니다.<br><br>Q1) 2 호기에서 1호기로 전환 될때 아래의 메세지가 발생하였습니다.<br>Oct 26 15:24:04 SLPCTIDL02 pengine[4029]:  notice: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired<br>Oct 26 15:24:04 SLPCTIDL02 pengine[4029]:  notice: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired<br><br>A1) 이 부분은 자동적으로 모니터링이 실패한 기록에 대해서 주기적으로 확인하고 fail count 를 지우는 동작입니다.<br>cluster-recheck-interval 설정과 failure-timeout 설정으로 조절이 가능합니다.<br><br>~~~<br>$ cat pcs_property_list_--all | egrep -i recheck<br> cluster-recheck-interval: 5min  &lt;&lt; 현재 5분으로 설정된 것을 확인할 수 있습니다.<br><br>Oct 26 15:24:04 [4030] SLPCTIDL02       crmd:     info: crm_timer_popped:       PEngine Recheck Timer (I_PE_CALC) just popped (300000ms)  &lt;&lt; 5분에 한번씩 Recheck Timer 가 수행됨을 알 수 있습니다.<br>Oct 26 15:24:04 [4030] SLPCTIDL02       crmd:   notice: do_state_transition:    State transition S_IDLE -&gt; S_POLICY_ENGINE | input=I_PE_CALC cause=C_TIMER_POPPED origin=crm_timer_popped<br>Oct 26 15:24:04 [4030] SLPCTIDL02       crmd:     info: do_state_transition:    Progressed to state S_POLICY_ENGINE after C_TIMER_POPPED<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:   notice: unpack_config:  On loss of CCM Quorum: Ignore<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: determine_online_status_fencing:        Node SLPCTIDL02-HB is active<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: determine_online_status:        Node SLPCTIDL02-HB is online<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: determine_online_status_fencing:        Node SLPCTIDL01-HB is active<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: determine_online_status:        Node SLPCTIDL01-HB is online<br>...<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:   notice: check_operation_expiry: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired | CTI_script_clear_failcount_0  &lt;&lt;<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: get_failcount_full:     CTI_script has failed 3 times on SLPCTIDL01-HB<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:   notice: check_operation_expiry: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired | CTI_script_clear_failcount_0  &lt;&lt;<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:   notice: unpack_rsc_op:  Re-initiated expired calculated failure CTI_script_monitor_60000 (rc=7, magic=0:7;4:18212:0:596fc60b-d87b-47d9-84d8-49277644659c) on SLPCTIDL01-HB<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:     info: get_failcount_full:     CTI_script has failed 3 times on SLPCTIDL01-HB<br>Oct 26 15:24:04 [4029] SLPCTIDL02    pengine:   notice: check_operation_expiry: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired | CTI_script_clear_failcount_0  &lt;&lt;<br>~~~<br><br><br>Q2) 이 메세지는 언제 발생하는지 확인 부탁 드립니다.<br>Oct 26 16:14:07 SLPCTIDL01 dracut: dracut-<br>Oct 26 16:14:07 SLPCTIDL01 dracut: Executing: /usr/sbin/dracut --list-modules<br><br>A2) 실제로 터미널에서 /usr/sbin/dracut --list-modules 명령어를 수행시 문의하신 로그가 /var/log/messages 에 남는 것을 확인하였습니다.<br>하지만 전후 로그에 특이사항이 없는 관계로 명확하게 원인을 파악하기 어렵습니다. 보내주신 로그에서는 단 한번만 출력된 것을 확인하였는데 당시에 해당 명령어를 입력하시거나 하지는 않으셨는지 확인 부탁드립니다.<br><br><br>위에 문의하신 내용은 현재의 이슈와 많은 연관이 있어보이지 않으며 클러스터 또는 OS 수준에서 문제가 될 만한 부분은 찾을 수 없었습니다.<br>다만 이전에 안내드린 것 처럼 no-quorum-policy: ignore 설정인 상태에서는 클러스터 로그 분석이 큰 의미가 없다는 부분 인지 부탁드립니다.<br>마지막으로 중요한 내용에 대해서 다시한번 정리하여 드립니다.<br><br> 1. 첫번째는 앞선 코멘트에서 언급한 &quot;no-quorum-policy&quot; 설정입니다. 전달 드린 것처럼 반드시 해당 설정을 unset 하시기 바랍니다.<br>unset 작업 진행시 시스템이 fencing 될 수 있으므로 반드시 다운타임을 가지고 진행하시기 바랍니다.<br><br> 2. 두번째는 사용자 스크립트의 lsb compliant 적합 여부 확인입니다. 잘못된 사용자 스크립트로 인하여 클러스터가 failover 되거나 오동작 될 수 있습니다.<br><br> 3. 세번째는 노드 shutdown 시에 graceful shutdown 되는 문제입니다.<br>이 경우에 정상적으로 fenced 처리 되지 않을 수 있으므로 첨부 문서 [1] 을 참조하셔서 시스템이 즉시 shutdown 될 수 있도록 조치 부탁드립니다.<br><br>[1] Fencing fails in a RHEL 7 High Availability cluster because systemd initiates a graceful shutdown<br>https://access.redhat.com/solutions/1578823<br><br>감사합니다.<br><br><publishedDate>2018-11-05T08:36:01Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O6RBzIAN"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-11-02T06:40:13Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-11-02T06:40:13Z</b><br><br>2 호기에서 1호기로 전환 될때 아래의 메세지가 발생하였습니다.<br>Oct 26 15:24:04 SLPCTIDL02 pengine[4029]:  notice: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired<br>Oct 26 15:24:04 SLPCTIDL02 pengine[4029]:  notice: Clearing failure of CTI_script on SLPCTIDL01-HB because it expired<br><br>이것에 대한 원인이 파악이 필요합니다.<br><br><br>1호기 2호기에서 <br><br>Oct 26 16:14:07 SLPCTIDL01 dracut: dracut-<br>Oct 26 16:14:07 SLPCTIDL01 dracut: Executing: /usr/sbin/dracut --list-modules<br><br>메세지가 발생했는데  이 메세지는 언제 발생하는지 확인 부탁 드립니다.<br><br><publishedDate>2018-11-02T06:40:13Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O6OvnIAF"><br>======================<br><b>생성계정 : Park, HyunYick</b><br><b>생성날짜 : 2018-11-02T01:54:47Z</b><br><b>마지막 답변자 : Park, HyunYick</b><br><b>마지막 수정 일자 : 2018-11-02T01:54:47Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>유선으로 안내드린 사항처럼 먼저 아래 URL 을 참조하셔서 사용자 스크립트 동작을 확인부탁드립니다.<br><br>&quot;Init Script LSB Compliance&quot;<br>https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html-single/Pacemaker_Explained/index.html#ap-lsb<br><br>추후 messages log 파일이 업로드 되는데로 확인 후 다시 업데이트 드리겠습니다.<br><br>감사합니다.<br><br><publishedDate>2018-11-02T01:54:47Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O6Oh7IAF"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-11-02T01:28:00Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-11-02T01:28:00Z</b><br><br>전체적인 상황 설명을 위해 바쁘시겠지만 연락 부탁 드립니다.<br><br><publishedDate>2018-11-02T01:28:00Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O6OfuIAF"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-11-02T01:24:49Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-11-02T01:24:49Z</b><br><br>네 레드햇  심우택 부장님 입니다.<br>저는 타임게이트 이승훈 수석입니다.<br>제 연락처는<br>010-5493-0769<br>sh.lee@time-gate.com<br>입니다.<br><br><publishedDate>2018-11-02T01:24:49Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O6OBpIAN"><br>======================<br><b>생성계정 : Park, HyunYick</b><br><b>생성날짜 : 2018-11-02T00:10:46Z</b><br><b>마지막 답변자 : Park, HyunYick</b><br><b>마지막 수정 일자 : 2018-11-02T00:10:46Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>현재 시스템의 상황 파악을 컨설턴트 분과 확인해보고자 합니다.<br>당시 지원하셨던 컨설턴트분의 성함 전달 부탁드립니다.<br><br>감사합니다.<br><br><publishedDate>2018-11-02T00:10:46Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O6EFfIAN"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-11-01T13:00:51Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-11-01T13:00:51Z</b><br><br>네 답변 감사합니다.<br>현재 말씀하신 no-quorum-policy  내용은  두 노드 로 클러스터 구성시 여기 상황에 맞게<br>레드햇 컨설턴트 분들께서 확인해서 작업해 주신 내용입니다.<br>문의 드린 내용은 <br>클러스터에서 업무 프로그램에 등록된 리소스가 문제가 발생하여<br>1호기에서 2호기로 넘어간 후 다시 2호기에서 1호기로 넘어간 원인과<br>업무 프로그램 이외에 os 적인 측면에 문제가 없었나 원인 분석 차원에 케이스 오픈 한 것입니다.<br>다시 한번 확인 부탁 드립니다.<br><br><publishedDate>2018-11-01T13:00:51Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O6AZMIA3"><br>======================<br><b>생성계정 : Park, HyunYick</b><br><b>생성날짜 : 2018-11-01T07:49:53Z</b><br><b>마지막 답변자 : Park, HyunYick</b><br><b>마지막 수정 일자 : 2018-11-01T07:49:53Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>문의하신 시스템은 클러스터 속성 no-quorum-policy 가 ignore 로 되어있습니다.<br><br> $ cat pcs_property_list_--all | grep no-quorum-policy<br>  no-quorum-policy: ignore<br><br>이와 같은 설정은 클러스터가 quorum 을 잃었을 때 적절한 조치없이<br>지속적으로 클러스터가 동작하게됨으로 클러스터가 정상적인 상태라는 것을 보장할 수 없게 됩니다.<br>이에따라 해당 설정은 기술지원 대상이 아니며<br>아래와 같이 정상적인 속성으로 복원하신 후 이슈 재발생시 새로운 sosreport 를 생성하셔서 문의 부탁드립니다.<br><br> # pcs property unset no-quorum-policy<br><br>이와 관련된 KCS 는 아래 첨부 문서 [1] 에서 참조 가능합니다.<br><br>[1] Can I configure pacemaker to continue to manage resources after a loss of quorum in RHEL 6 or 7?<br>https://access.redhat.com/solutions/645843<br><br>감사합니다.<br><br><publishedDate>2018-11-01T07:49:53Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O678LIAR"><br>======================<br><b>생성계정 : Park, HyunYick</b><br><b>생성날짜 : 2018-11-01T01:19:49Z</b><br><b>마지막 답변자 : Park, HyunYick</b><br><b>마지막 수정 일자 : 2018-11-01T01:19:49Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>Platform Support 를 담당하고 있는 Technical Support Engineer 박현익 입니다.<br>올려주신 문의내용은 현재 자세히 살펴보고 있는중이며, 확인 되는대로 업데이트 드리도록 하겠습니다.<br><br>감사합니다.<br><br><publishedDate>2018-11-01T01:19:49Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O5sTeIAJ"><br>======================<br><b>생성계정 : 타임게이트, 타임게이트</b><br><b>생성날짜 : 2018-10-31T09:26:31Z</b><br><b>마지막 답변자 : 타임게이트, 타임게이트</b><br><b>마지막 수정 일자 : 2018-10-31T09:26:31Z</b><br><br>클러스터 resource 중 cti  스크립트 입니다.<br>lsb 방식으로 등록하여 사용하고 있습니다.<br> cat cti_script.sh<br>#!/bin/sh<br><br><br>PSNUM() {<br>        ps -ef |egrep &quot;nxstate|nxmedia_scm&quot; | grep -v grep | wc -l<br>}<br><br>start() {<br>#       ls /cube/nexus/products/cube/bin<br>        su - ctibg1 -c &quot;cd /cube/nexus/products/cube/bin ; ./nxstart&quot;<br>}<br><br>stop() {<br>        su - ctibg1 -c &quot;cd /cube/nexus/products/cube/bin ; ./nxstop &lt; fstop.txt&quot;<br>}<br><br><br>case &quot;$1&quot; in<br>  start)<br>    if [ $(PSNUM) -eq 2 ]; then<br>        echo &quot;CTI-CUBE is already running&quot;<br>        exit 0<br>    fi<br>        logger &quot;starting CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstart' &quot;<br>        stop<br>        start<br>        sleep 3<br>    if [ $(PSNUM) -eq 2 ]; then<br>        echo &quot;CTI-CUBE is started&quot;<br>        exit 0<br>    else<br>        echo &quot;CTI-CUBE start failed&quot;<br>        exit 1<br>    fi<br>  ;;<br><br>  stop)<br>    if [ $(PSNUM) -eq 0 ]; then<br>        echo &quot;CTI-CUBE is already stopped&quot;<br>        exit 0<br>    fi<br>        logger &quot;stopping CTI-CUBE  'su - ctibg1 -c cd /cube/nexus/products/cube/bin ; ./nxstop' &quot;<br>        stop<br>        sleep 3<br>    if [ $(PSNUM) -eq 0 ]; then<br>        echo &quot;CTI-CUBE is stopped&quot;<br>        exit 0<br>    else<br>        echo &quot;CTI-CUBE stop failed&quot;<br>        exit 1<br>    fi<br>  ;;<br><br>  status)<br>   if [ $(PSNUM) -eq 2 ] ; then<br>        echo &quot;CTI-CUBE running&quot;<br>        exit 0<br>   else<br>        echo &quot;CTI-CUBE Not running&quot;<br>        exit 1<br>   fi<br>  ;;<br><br>  *)<br>   echo $&quot;Usage: $0 {start|stop|status}&quot;<br>   exit 2<br>  ;;<br>esac<br><br><publishedDate>2018-10-31T09:26:31Z</publishedDate><createdByType>Customer</createdByType><br>======================<br></comments><br>
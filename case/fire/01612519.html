======================<br><b>생성계정 : 주호 이</b><br><b>생성날짜 : 2016-04-06T07:24:36Z</b><br><b>마지막 답변자 : JINKOO HAN</b><br><b>마지막 수정 일자 : 2016-07-11T04:13:48Z</b><br><b>id : 500A000000U7KasIAF</b><br>======================<br><br><b><font size=15>
제목  : [BZ] a.<br>rounding off error 로 인해 잘못된 계산값을 반환을 하는 버그
</font></b><br><br>======================<br><b>사전문의<br></b><br>어떤 문제/오류/결함이 발생했습니까? 기대하시는 결과는 무엇입니까?<br><br>dump analyze<br>So the cause of the issue is in this code in the calculation of core_pct (this is from 2.6.32-573):<br><br>0558 static inline void intel_pstate_calc_busy(struct cpudata *cpu,<br>0559                                         struct sample *sample)<br>0560 {<br>0561         int32_t core_pct;<br>0562         int32_t c0_pct;<br>0563 <br>0564         core_pct = div_fp(int_tofp((sample-&gt;aperf)),<br>0565                         int_tofp((sample-&gt;mperf)));<br>0566         core_pct = mul_fp(core_pct, int_tofp(100));<br>0567         FP_ROUNDUP(core_pct);<br><br>Here we do the divide first and then multiply it by 100 to get to a percentage. The problem is that if the difference between aperf and mperf is too large the first part of the calculation becomes 0.<br><br>0568 <br>0569         c0_pct = div_fp(int_tofp(sample-&gt;mperf), int_tofp(sample-&gt;tsc));<br>0570 <br>0571         sample-&gt;freq = fp_toint(<br>0572                 mul_fp(int_tofp(cpu-&gt;pstate.max_pstate * 1000), core_pct));<br><br>When we use the value of core_pct above we cause a divide by zero to occur. In the dump the instruction associated with this is:<br><br>0xffffffffa00c8a5b &lt;intel_pstate_timer_func+267&gt;:       idiv   %rsi<br><br>And rsi is 0 at at the time of the failure.<br><br>0573 <br>0574         sample-&gt;core_pct_busy = mul_fp(core_pct, c0_pct);<br>0575 }<br><br>In RHEL 7 that code looks like this (after backporting a fix for this in 3.10.0-288 (that's a change log kernel version)):<br><br>0733 static inline void intel_pstate_calc_busy(struct cpudata *cpu)<br>0734 {<br>0735         struct sample *sample = &amp;cpu-&gt;sample;<br>0736         int64_t core_pct;<br>0737 <br><br>You can see below that we now multiply by 100 before doing the divide so we don't have major issues with rounding off errors in the calculation:<br><br>0738         core_pct = int_tofp(sample-&gt;aperf) * int_tofp(100);<br>0739         core_pct = div64_u64(core_pct, int_tofp(sample-&gt;mperf));<br>0740 <br>0741         sample-&gt;freq = fp_toint(<br>0742                 mul_fp(int_tofp(<br>0743                         cpu-&gt;pstate.max_pstate * cpu-&gt;pstate.scaling / 100),<br>0744                         core_pct));<br>0745 <br>0746         sample-&gt;core_pct_busy = (int32_t)core_pct;<br>0747 }<br><br>To illustrate that instead of:<br><br>(10000/1000000) * 100 = 0<br><br>we get <br><br>(10000*100)/1000000 = 1<br><br>Note that they are not the actual values that would be in use in the calculations they are there to illustrate the difference between doing integer calculations in different ways can lead to different values being calculated caused by rounding off errors.<br><br>There is no fix for this issue in any currently released RHEL 6 kernel. I need to open a case with Redhat to request a backport of the changes to RHEL 6 (there may already be a request to do that but I need to open a case to find out). To do that I need the customers RHN id that covers the support for this system via HPE without it I am unable to do anything further with this case.<br><br>3. 로그 분석 결과<br>a.<br>rounding off error 로 인해 잘못된 계산값을 반환을 하는 버그가 panic의 원인 입니다.<br>b.<br>이 문제는 RHEL 6 버전은 모두 해당이 됩니다. RHEL 7 에서는 해결이 되었습니다.<br><br>어디서 문제가 발생했습니까? 어떤 환경에서 발생했습니까?<br><br>해당문제는 6.6 버전에서 발생을 하였고, RHEL7 에서는 Fix 가되었는데 6버전은 아직 패치가 안나왔다고 들었습니다.<br><br>언제 문제가 발생했습니까? 이러한 문제가 자주 발생합니까? 반복적으로 발생합니까? 특정 시간에 발생합니까?<br><br>cpu core 퍼센트 계산시 0으로 나누는 경우가 발생하면서 문제가 되는 버그로 알고 있습니다.<br>관련하여 RHEL 6.6, 6.7 버전에서 패치가 있는 지 문의드립니다.<br>추가로 work around 조치가 있는지도 문의드립니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 6.7</b><br><b>계정 번호  : 1596892</b><br><b>심각도  : 3 (Normal)</b><br><br><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-07-11T04:13:45Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-07-11T04:13:45Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>본 케이스의 Errata가 release되고 추가 문의사항이 없으셔서 본 케이스는 Close하도록 하겠습니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-07-11T04:13:45Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000HNIk8IAH"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-07-06T00:47:50Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-07-06T00:47:50Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>본 케이스와 관련되어 RHEL6.6 버젼에 대한 패치가 금일 release되었습니다.<br><br>커널 kernel-2.6.32-504.50.1.el6 버젼으로 업데이트 하시면 되며, 아래에 Errata 정보를 첨부하여 드립니다.<br><br>Errata: https://access.redhat.com/errata/RHBA-2016:1382<br>======================<br><br>감사합니다.<br><br><publishedDate>2016-07-06T00:47:50Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000HAiFLIA1"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-06-01T02:28:06Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-06-01T02:28:06Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>앞서 안내드렷던 Hotfix를 반영해보셨는지요? 반영후 동일한 이슈가 발생하는지 여부에 대한 feed-back 바랍니다.<br>======================<br><br>감사합니다.<br><br><publishedDate>2016-06-01T02:28:06Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000H9LunIAF"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-05-24T07:40:36Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-05-24T07:41:26Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>본 이슈와 관련되어 RHEL6.6에 대한 패치는 현재 진행중에 있으며, release에 앞서서 HotFix를 먼저 제공받았습니다.<br><br>현재 이슈가 되는 시스템에 해당 HotFix를 적용해보시고 동일한 이슈 발생여부에 대한 feedback 바랍니다.<br><br>Hotfix 파일은 케이스에서 다운로드 가능하시며 파일명은 아래와 같습니다.<br>- kernel-2.6.32-504.50.1.el6.x86_64.rpm<br>- kernel-headers-2.6.32-504.50.1.el6.x86_64.rpm<br><br>다운로드와 관련되어 이슈가 있으시면 업데이트 바랍니다.<br>======================<br><br>감사합니다.<br><br><publishedDate>2016-05-24T07:40:36Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000GEE4sIAH"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-05-11T00:31:01Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-05-11T00:31:01Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>우선 본 버그와 관련된 패치가 적용되어 새로운 커널이 release되었습니다.<br><br>해당 버젼은 다음과 같으므로, RHN에서 해당 패키지를 업데이트 하시기 바랍니다. <br><br>- kernel ver. kernel-2.6.32-642.el6<br><br><br>그리고 관련된 Errata 정보를 아래 첨부하여 드립니다.<br>- Errata, https://rhn.redhat.com/errata/RHSA-2016-0855.html<br><br><br>추가적으로 현재 6.6 EUS 에 패치를 위한 검토가 현재 진행중에 있습니다. 향후 6.6 패치와 관련되어 업데이트를 드리도록 하겠습니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-05-11T00:31:01Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000H5cSpIAJ"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-05-10T02:38:50Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-05-10T02:38:50Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>현재 본 케이스와 관련되어 패치를 위한 작업이 진행중인 상태입니다. 또한, RHEL6.6에 백포팅을 위한 작업도 현재 검토중인 상태입니다.<br><br>추후 업데이트가 있으면 다시 업데이트 드리도록 하겠습니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-05-10T02:38:50Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000GpfcYIAR"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-04-11T00:27:57Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-04-11T00:27:57Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>해당 패치와 관련되어 내부적으로 이미 패치를 위한 작업을 진행하고 현재 QA단계에 있는 것으로 확인됩니다.<br><br>추가 업데이트가 있으면 다시 업데이트 드릴 수 있도록 하겠습니다.<br>======================<br><br>감사합니다.<br><br><publishedDate>2016-04-11T00:27:57Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000GpfWQIAZ"><br>======================<br><b>생성계정 : Kwon, Daniel</b><br><b>생성날짜 : 2016-04-10T23:54:34Z</b><br><b>마지막 답변자 : Kwon, Daniel</b><br><b>마지막 수정 일자 : 2016-04-10T23:54:34Z</b><br><br>Hi,<br><br>Just want to let you know. It turned out that we already had a Bugzilla ticket for this and it's on QA stage at the moment. We'll update you once we have any further progress. Thanks.<br><br>Best regards,<br>Daniel Kwon<br>Software Maintenance Engineer, GSS, Red Hat Asia Pacific<br><br><publishedDate>2016-04-10T23:54:34Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gp8gXIAR"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-04-07T06:14:37Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-04-07T06:14:37Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>현재 HP에서 동일한 이슈를 저희 Red Hat으로 vmcore와 함께 오픈한 것이 확인되고 있습니다.<br>그래서 별도로 vmcore upload는 없어도 될 것 같으며, 해당 이슈에 대해서 현재 Bugzilla를 오픈하였고 해당 버그질라를 통해서 RHEL6 패치를 위한 프로세스를 진행중에 있습니다.<br><br><br>해당 프로세스의 일정은 명시하기가 어렵습니다. 그래서 관련되어 추가 업데이트가 있으면 업데이트 드릴 수 있도록 하겠습니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-04-07T06:14:37Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gp8UHIAZ"><br>======================<br><b>생성계정 : Kwon, Daniel</b><br><b>생성날짜 : 2016-04-07T05:52:34Z</b><br><b>마지막 답변자 : Kwon, Daniel</b><br><b>마지막 수정 일자 : 2016-04-07T05:52:33Z</b><br><br>Hi,<br><br>We've got the vmcore from HP as they had raised a case with us for the same issue. We were able to confirm the description and raised bugzilla ticket internally to apply the below patches.<br><br>http://article.gmane.org/gmane.linux.kernel.commits.head/451851/match=bf8102228a8bf053051f311e5486042fe0542894<br><br>http://article.gmane.org/gmane.linux.kernel.commits.head/473077/match=78e2708691e9289f97750eb71aca31b5a2973d94<br><br>Above patches are already applied in RHEL7, so shouldn't be an issue.<br><br>We'll follow you up once there's any updates from engineering team. Thanks.<br><br>Best regards,<br>Daniel Kwon<br>Software Maintenance Engineer, GSS, Red Hat Asia Pacific<br><br><publishedDate>2016-04-07T05:52:33Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gp7GYIAZ"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-04-07T01:53:39Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-04-07T01:53:39Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>저희 엔지니어와 상의한 결과 vmcore를 직접 확인이 필요할 것 같습니다.<br><br>해당 vmcore파일을 저희 dropbox로 upload 해주실 수 있으신지요?<br>업로드 바랍니다.<br>======================<br><br>추가적으로, 지금 확인한 것이데요.. 케이스 severity가 2로 설정되어있습니다.<br>저희 severity는 처리 속도를 의미하는 것이 아니고 현재의 severity는 3에 해당되는 상황으로 해당 severity를 3으로 조절하겠습니다.<br><br>severity가 조절되더라도 담당자인 제가 처리할 것이기 때문에 처리속도는 걱정하지 않으셔도 됩니다.<br>======================<br><br>감사합니다.<br><br><publishedDate>2016-04-07T01:53:39Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000GovjjIAB"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-04-07T01:38:00Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-04-07T01:37:59Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>추가 업데이트 드립니다.<br><br>해당 코드를 좀 더 자세히 샆펴본 결과, 해당 패치는 RHEL7 3.10.0에 이미 패치가 된 부분입니다.<br><br>그리고 코드상으로만 봤을때는 RHEL6.7 최슨 커널에 해당 부분의 이슈 발생의 가능성이 있어 보여서 우선 해당 케이스를 전문 엔지니어들과 상의하기 위해서 내부적으로 Escalation을 한 상태입니다.<br><br><br>우선 상의하고 확인하여 다시 업데이트 드리도로 하겠습니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-04-07T01:37:59Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000GovLWIAZ"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-04-07T00:13:54Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-04-07T00:13:53Z</b><br><br>안녕하세요,<br>Red Hat Technical Account Manager 한진구 입니다.<br><br>우선 해당 코드가 RHEL7.1에서 부터 수정이 된 것으로 간략하게 확인하였습니다.<br><br>현재 HP의 내용은 vmcore를 분석하고 해당 부분이 RHEL7.1에 반영되어있으나 해당 코드가 RHEL6에는 없다는 것으로 유추됩니다.<br>RHEL6와 RHEL7에서는 커널의 많은 변화가 있기 때문에 이부분이 반드시 RHEL6에서도 가지는 장애라고 정의내리기는 어려우나 충분히 가능성은 있어 보입니다.<br><br>현재 RHEL7.1에서 변화이다보니, kernel의 upstream에서부터 해당 부분의 내용을 찾아야 할 것으로 보입니다. 해당 부분을 찾고 다시 RHEL6에 반영여부를 확인해야 함으로 확인하는데 조금 시간이 소요될 것으로 보입니다.<br><br><br>우선 확인하는데로 바로 업데이트드리도록 하겠습니다.<br><br><br>감사합니다.<br><br><publishedDate>2016-04-07T00:13:53Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>So the cause of the issue is in this code in the calculation of core_pct (this is from 2.6.32-573):<br><br>0558 static inline void intel_pstate_calc_busy(struct cpudata *cpu,<br>0559                                         struct sample *sample)<br>0560 {<br>0561         int32_t core_pct;<br>0562         int32_t c0_pct;<br>0563 <br>0564         core_pct = div_fp(int_tofp((sample-&gt;aperf)),<br>0565                         int_tofp((sample-&gt;mperf)));<br>0566         core_pct = mul_fp(core_pct, int_tofp(100));<br>0567         FP_ROUNDUP(core_pct);<br><br>Here we do the divide first and then multiply it by 100 to get to a percentage. The problem is that if the difference between aperf and mperf is too large the first part of the calculation becomes 0.<br><br>0568 <br>0569         c0_pct = div_fp(int_tofp(sample-&gt;mperf), int_tofp(sample-&gt;tsc));<br>0570 <br>0571         sample-&gt;freq = fp_toint(<br>0572                 mul_fp(int_tofp(cpu-&gt;pstate.max_pstate * 1000), core_pct));<br><br>When we use the value of core_pct above we cause a divide by zero to occur. In the dump the instruction associated with this is:<br><br>0xffffffffa00c8a5b &lt;intel_pstate_timer_func+267&gt;:       idiv   %rsi<br><br>And rsi is 0 at at the time of the failure.<br><br>0573 <br>0574         sample-&gt;core_pct_busy = mul_fp(core_pct, c0_pct);<br>0575 }<br><br>In RHEL 7 that code looks like this (after backporting a fix for this in 3.10.0-288 (that's a change log kernel version)):<br><br>0733 static inline void intel_pstate_calc_busy(struct cpudata *cpu)<br>0734 {<br>0735         struct sample *sample = &amp;cpu-&gt;sample;<br>0736         int64_t core_pct;<br>0737 <br><br>You can see below that we now multiply by 100 before doing the divide so we don't have major issues with rounding off errors in the calculation:<br><br>0738         core_pct = int_tofp(sample-&gt;aperf) * int_tofp(100);<br>0739         core_pct = div64_u64(core_pct, int_tofp(sample-&gt;mperf));<br>0740 <br>0741         sample-&gt;freq = fp_toint(<br>0742                 mul_fp(int_tofp(<br>0743                         cpu-&gt;pstate.max_pstate * cpu-&gt;pstate.scaling / 100),<br>0744                         core_pct));<br>0745 <br>0746         sample-&gt;core_pct_busy = (int32_t)core_pct;<br>0747 }<br><br>To illustrate that instead of:<br><br>(10000/1000000) * 100 = 0<br><br>we get <br><br>(10000*100)/1000000 = 1<br><br>Note that they are not the actual values that would be in use in the calculations they are there to illustrate the difference between doing integer calculations in different ways can lead to different values being calculated caused by rounding off errors.<br><br>There is no fix for this issue in any currently released RHEL 6 kernel. I need to open a case with Redhat to request a backport of the changes to RHEL 6 (there may already be a request to do that but I need to open a case to find out). To do that I need the customers RHN id that covers the support for this system via HPE without it I am unable to do anything further with this case.<br><br>3. 로그 분석 결과<br>a.<br>rounding off error 로 인해 잘못된 계산값을 반환을 하는 버그가 panic의 원인 입니다.<br>b.<br>이 문제는 RHEL 6 버전은 모두 해당이 됩니다. RHEL 7 에서는 해결이 되었습니다.</issue><environment>해당문제는 6.6 버전에서 발생을 하였고, RHEL7 에서는 Fix 가되었는데 6버전은 아직 패치가 안나왔다고 들었습니다.</environment><periodicityOfIssue>cpu core 퍼센트 계산시 0으로 나누는 경우가 발생하면서 문제가 되는 버그로 알고 있습니다.<br>관련하여 RHEL 6.6, 6.7 버전에서 패치가 있는 지 문의드립니다.<br>추가로 work around 조치가 있는지도 문의드립니다.</periodicityOfIssue><cep>false</cep><folderName>ERP-ALL</folderName></case>
======================<br><b>생성계정 : support os</b><br><b>생성날짜 : 2019-03-22T01:51:05Z</b><br><b>마지막 답변자 : Xingbin Li</b><br><b>마지막 수정 일자 : 2019-04-03T07:13:54Z</b><br><b>id : 5002K00000dQ7wsQAC</b><br>======================<br><br><b><font size=15>
제목  : OS is ignoring SYN packets(L4 스위치 내부 통신시 connection 오류 관련)
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하십니까 타임게이트 오선우입니다<br>타임게이트 / 오선우 / 수석보 / 010-4630-3171 / sw.oh@time-gate.com<br><br>고객사에 아래와 같이 통신이 정상인 부분과 정상적이지 않은 부분이 있어서 덤프 분석 요청드립니다<br>그림파일 함께 첨부드립니다<br><br>----------------------<br><br>상암센터 신규 대외계 서버의 L4 스위치 내부 통신시에 Connection 오류가 발생하여 tcpdump 수행하였으며 문제 분석 요청드립니다.<br><br>아래 그림과 같이 L4를 통한 포트포워딩(TCP/59904)에서는 Connection 오류가 발생하고, Real IP를 통해서는 Connection이 정상적으로 수행되는<br><br> <br><br>문제가 발생하고 있습니다.<br><br> <br><br>각 서버별 tcmpdump 및 netstat 로그는 문제발생을 재현하여 before(L4 포트포워딩)/after(Real IP 통신)로 구분하여 파일첨부드립니다<br> <br><br>before case 에서 3호기 netstat 로그에 실패시(syn_sent 상태) 통신 포트 및 시간 확인가능하시며 , after case 에서는 실패가 없었습니다.<br>------------------<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>타입  : RCA Only</b><br><b>계정 번호  : 1596892</b><br><b>심각도  : 3 (Normal)</b><br><hostname>-</hostname><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0a2K00000PpCqFQAV"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-04-03T07:13:36Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-04-03T07:13:36Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>피드백 주셔서 매우 감사드립니다. 본 케이스는 종료처리 하도록 하겠습니다.<br>만약 본 케이스와 관련하여 추가 질문이 있으시다면 언제든지 재오픈하실 수 있습니다.  <br>  <br>케이스가 처리 완료되면 가능하게 고객 설문조사 메일이 발생됩니다. <br>고객님께서 남기신 의견은 보다 나은 서비스를 위해 지속적으로 반영될 것입니다. <br>향후 기술 지원 서비스의 품질 향상을 위해, 소중한 시간을 내어 주시면 대단히 감사드리겠습니다.  <br>  <br>감사합니다.<br><br><publishedDate>2019-04-03T07:13:36Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PpCmSQAV"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-04-03T07:10:15Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-04-03T07:10:15Z</b><br><br>안녕하십니까 타임게이트 오선우입니다<br><br>도움주셔서 모두 잘 해결되었습니다<br><br>케이스는 종료하도록 하겠습니다<br><br>감사합니다<br><br><publishedDate>2019-04-03T07:10:15Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PoqGPQAZ"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-04-02T04:17:02Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-04-02T04:17:01Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services 입니다.<br><br>본 케이스와 연관되어 추가적으로 문의하실 사항이 있으신가요?<br><br>본 안내 후 일정기간 답변이 없다면 본 케이스는 자동으로 종료 상태가 됨을 알려 드립니다.<br><br>만약 추가적인 지원이 필요하시다면, 연락 부탁드립니다.<br><br>감사합니다.<br><br><publishedDate>2019-04-02T04:17:01Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PnsesQAB"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-28T04:41:42Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-28T04:41:41Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>먼저 아래와 같이 설정하신후, 테스트 하셔도 됩니다.<br>다만 앞서 말씀드렸던 바와 같이 NAT 를 수행하는 경우, Red Hat에서는 <br>세 파라메터 모두 비활성화 하시는 것을 권장드리는다는 점 다시 한번 말씀드립니다.<br><br>tcp_tw_recycle = 0<br>tcp_tw_reuse = 0<br>tcp_timestamps = 1<br><br>상기와 같이 설정했음에도 불구하고 계속 이슈가 발생한다면 <br>세 파라메터 모두 0으로 설정하신후 테스트가 필요합니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-28T04:41:41Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PnsavQAB"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-03-28T04:34:31Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-03-28T04:34:31Z</b><br><br>자세한 답변 감사합니다<br><br>해당 파라미터 확인결과<br><br>해당 증상이 발생하지 않는 정상장비의 경우<br><br>아래와 같이 설정이 되어 있다는것이 확인이 되었는데요<br>tcp_tw_recycle = 0<br>tcp_tw_reuse = 0<br>tcp_timestamps = 1<br><br>이와 같이 변경을 해서 증상 재발이 되는지 확인해보는 것이 좋을까요? 아니면 모두 0(disable)으로 변경해서 증상확인 하는것이 좋을지<br><br>조언 부탁드립니다<br><br>DR장비에 해당 파라미터들을 0(disable)하여 증상이 발생하는지 테스트 해보려고 합니다<br><br><publishedDate>2019-03-28T04:34:31Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PnXK8QAN"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-27T01:17:56Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-27T01:17:56Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>&gt;L4스위치에서 패킷을 수신하면 출발지 IP를 L4스위치가 갖고 있는 G/W IP로 변경하여(SNAT) Rserver로 포워딩.<br><br>내부적으로 네트워킹 엔지니어 분들이 검토한 결과 본 이슈는 <br>NAT 환경에서 아래와 같은 파라메터를 활성화하여 생겼을 가능성으로 보고 있습니다.<br><br>tcp_tw_recycle = 1<br>tcp_tw_reuse = 1<br>tcp_timestamps = 1<br><br>NAT 기능을 수행할때 상기와 같은 파라메터를 활성화할때 본 이슈와 같이 SYN 패킷이 보내왔음에도 불구하고 무시하고 <br>tcp connection 을 생성하지 않는 이슈가 발생할 수 있다고 보고되어 있습니다. 따라서 Red Hat 에서는 상기의 세 <br>파라메터를 NAT 환경하에서는 disable 하시는 것을 권장드리고 있습니다.<br><br>따라서 테스트가 가능할시, 서버단에서 상기와 같은 파라메터를 0으로 비활성화 하신후에도 증상 재발이 되는지 확인 부탁드리겠습니다.<br><br><br>[참고자료]<br><br>Why does Red Hat Enterprise Linux not respond to SYN requests intermittently? <br>https://access.redhat.com/solutions/18035<br><br>감사합니다.<br><br><publishedDate>2019-03-27T01:17:56Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PnKMVQA3"><br>======================<br><b>생성계정 : Harris, Jeremy</b><br><b>생성날짜 : 2019-03-26T10:58:16Z</b><br><b>마지막 답변자 : Harris, Jeremy</b><br><b>마지막 수정 일자 : 2019-03-26T10:58:16Z</b><br><br>Hi,<br><br><br>The server system has tcp_tw_recycle set:<br><br>[ sosreport-mwb2bp01-20190322181244]$ cat proc/sys/net/ipv4/tcp_tw_recycle <br>1<br>[ sosreport-mwb2bp01-20190322181244]$ cat proc/sys/net/ipv4/tcp_tw_reuse <br>1<br><br><br>This is incompatible with a NAT environment, which appears to be what the &quot;L4 switch&quot; is providing.  As a result, connections are being rejected.<br>Please refer to this article:  https://access.redhat.com/solutions/1263863<br><br><br>The server is also using tcp_timestamps, which is normally a good practice - except in a NAT environment:<br><br>[jgh@soschk sosreport-mwb2bp01-20190322181244]$ cat proc/sys/net/ipv4/tcp_timestamps <br>1<br><br>Please refer to this article:  https://access.redhat.com/solutions/18035<br><br><br>If you wish to use this NAT environment you will need to disabled both tw_recycle and timestamps on the server.<br><br>Regards,<br>Jeremy Harris<br>Red Hat EMEA Global Support Services<br><br><publishedDate>2019-03-26T10:58:16Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PnIrfQAF"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-26T09:26:18Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-26T09:26:18Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>자세한 설명 감사드립니다.<br><br>&gt;SNAT 설정 : 같은 Broadcasting Domain 내 통신(예를 들어 42.1.43.101 - 42.1.43.150 간 통신) 시 비대칭 송수신 방지 목적<br> <br>  스위치벤더사에서는 해당 기능에 대해 네트워킹 전문용어로 영어로 어떻게 부르는지 확인해주실수 있을가요? <br><br>&gt; 현재 해당 장비는 대외 서비스 오픈으로 테스트가 쉽지는 않습니다. 반드시 필요한 경우라면 최대한 수집해보도록 하겠습니다<br><br>  네, 가능하시다면 수집 부탁드리겠습니다. 그리고 테스트시 다시 tcpdump 도 수집 부탁드리겠습니다. <br>  기존의 tcpdump 와 sosreport 에 대해서도 전문 엔지니어 그룹에 의뢰를 넣은 상황입니다만 아직 <br>  명확한 분석결과가 나오지 않았습니다. 답변이 다소 지연되는 점 죄송합니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-26T09:26:18Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PnGzbQAF"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-03-26T07:32:39Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-03-26T07:32:38Z</b><br><br>요청하신 부분에 확인하여 회신드립니다. (2,3번은 NW 담당자에게 확인하여 회신받은 내용입니다.)<br><br> <br><br> 1. 스위치를 통해 커넥션 실패 현상이 발생할때 앞서 보내드린 1초에 한번 씩 수집해주신 방법으로 하나의 포트가 아닌 전체 내용을 수집해주실수 있으신지요? netstat -pant<br><br> <br><br>현재 해당 장비는 대외 서비스 오픈으로 테스트가 쉽지는 않습니다. 반드시 필요한 경우라면 최대한 수집해보도록 하겠습니다.<br><br> <br><br>2. L4 스위치 설정상에서 문제가 없는지 다시한번 점검 부탁드리며, 스위치 내부가 아닌 외부 장비에서 부터 스위치 내부 서버로도 tcp 커넥션이 맺어지지 않는지 확인 부탁드립니다.<br><br>L4스위치 설정은 이상 없습니다. 대외계 서버팜 외부 → 대외계 서버팜 내부 서버 접속 시 이슈 발생은 없는 것으로 알고 있습니다.<br><br><br>3. L4 스위치의 작용에 대해 조금더 구체적인 설명 부탁드립니다. 패킷의 목적 포트를 기반으로 포워딩을 하는 것이 맞나요?<br><br><br>L4스위치 정책은 아래와 같이 설정됨<br><br>- Vserver : 42.1.43.150:59904<br><br>- Rserver : 42.1.43.101:59904, 42.1.43.102:59904<br><br>- SNAT 설정 : 같은 Broadcasting Domain 내 통신(예를 들어 42.1.43.101 - 42.1.43.150 간 통신) 시 비대칭 송수신 방지 목적<br><br> <br><br>42.1.43.101 → 42.1.43.150:59904 통신 시 아래와 같이 통신되어야 함<br><br>표는 해당 패킷 헤더의 출발지/목적지 IP를 의미함<br><br> <br><br>(1) 출발지에서 아래와 같이 패킷 생성하여 송신<br><br>출발지 : 42.1.43.101<br><br>목적지: 42.1.43.150:59904<br><br> <br><br>(2) L4스위치에서 패킷을 수신하면 출발지 IP를 L4스위치가 갖고 있는 G/W IP로 변경하여(SNAT) Rserver로 포워딩<br><br>출발지 : 42.1.43.1<br><br>목적지 : 42.1.43.101:59904<br>======================<br>(3) 목적지에서 패킷을 수신하고, 이에 대한 응답 패킷을 G/W IP로 송신 - 현재 해당 서버에서 이 응답 패킷 생성하지 않거나, 생성 후 송신하지 않는 것으로 보임.<br><br>출발지 : 42.1.43.101:59904<br><br>목적지 : 42.1.43.1<br><br><br>(4) L4스위치에서 응답 패킷을 수신하면 패킷의 출발지 IP를 Vserver IP로 복원하여 포워딩<br><br>출발지 : 42.1.43.150:59904<br><br>목적지 : 42.1.43.101<br>======================<br><br><br><br> <br><br>감사합니다.<br><br><publishedDate>2019-03-26T07:32:38Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PnEzUQAV"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-03-26T04:40:31Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-03-26T04:40:31Z</b><br><br>안녕하십니까 오선우입니다<br><br>우선 내용은 고객에게 전달했고 확인되는 즉시 업데이트 하도록 하겠습니다<br><br>1차적으로 나온 분석결과가 있으면 공유부탁드립니다<br><br><publishedDate>2019-03-26T04:40:31Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PnDS7QAN"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-26T01:34:31Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-26T01:34:31Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>시니어 그룹의 엔지니어의 추가 질문을 전달드립니다.<br><br>1. 스위치를 통해 커넥션 실패 현상이 발생할때 앞서 보내드린 1초에 한번 씩 수집해주신 방법으로 하나의 포트가 아닌 전체 내용을 수집해주실수 있으신지요? <br><br>netstat -pant <br><br>2. L4 스위치 설정상에서 문제가 없는지 다시한번 점검 부탁드리며, 스위치 내부가 아닌 외부 장비에서 부터 스위치 내부 서버로도 tcp 커넥션이 맺어지지 않는지 확인 부탁드립니다.<br><br>3. L4 스위치의 작용에 대해 조금더 구체적인 설명 부탁드립니다. 패킷의 목적 포트를 기반으로 포워딩을 하는 것이 맞나요? <br><br>감사합니다.<br><br><publishedDate>2019-03-26T01:34:31Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PmyT8QAJ"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-03-25T08:40:36Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-03-25T08:40:36Z</b><br><br>네 맞습니다<br><br>l4 안통하고 리얼ip로는 통신이 잘되고<br><br>l4쪽 거쳐서 포트포워딩시 통신이 끈기는 경우가 간헐적으로 있습니다<br><br><publishedDate>2019-03-25T08:40:36Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000PmxFKQAZ"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-25T07:09:28Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-25T07:09:28Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>추가질문 드립니다.<br>mwb2bp02 와 mwb2bp04 장비사이에서도 L4 로 포워딩시에만 connection 연결이 안되는 현상이 발생하는지 확인 부탁드립니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-25T07:09:28Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PmuRPQAZ"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-25T02:01:00Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-25T02:01:00Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>확인 감사드립니다<br>추가 조사후 답변이 정리되는 대로 코멘트를 업데이트 하겠습니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-25T02:01:00Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000Pmu3rQAB"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2019-03-25T01:03:52Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2019-03-25T01:03:51Z</b><br><br>구성에 대해서 추가로 말씀드리면 L4 스위치가 L3의 라우팅 기능까지 겸하는 장비입니다.<br><br> <br><br>상단의 L3는 방화벽 연동을 위한 중간 역할만 하며 서버에서는 물리적으로 L4에만 연동되어 있습니다.<br><br> <br><br>42.1.43.150은 L4 Service IP<br><br>42.1.43.1은 L4(L3 라우팅 기능 포함) Gateway IP <br><br> <br><br>1. L4 포워딩할때의 라우팅 경로가 어떻게 되는지 확인 부탁드리겠습니다. <br><br>(.201 -&gt; .101 포워딩할시 어떤 장비를 거치게 되는지)<br><br>→ L4 스위치가 L3 라우팅 기능을 겸하기에 L4에서만 라우팅이 진행됩니다.<br><br>&lt;x.x.x.103 → x.x.x.101 traceroute&gt;<br>[root@mwb2bp03:/var/tmp]#traceroute 42.1.43.101<br><br>traceroute to 42.1.43.101 (42.1.43.101), 30 hops max, 60 byte packets<br><br>1  mwb2bp01 (42.1.43.101)  0.200 ms  0.303 ms *<br><br> <br><br><br>2. 패킷 덤프를 보면 .101 장비가 syn 패킷을 42.1.43.1 로 부터 받는 것으로 보입니다.<br>&quot;42.1.43.1&quot; 가 무슨 장비인지 확인 바랍니다.<br><br>→ 42.1.43.1은 Gateway IP 입니다.<br>[root@mwb2bp03:/var/tmp]#netstat -rn<br><br>Kernel IP routing table<br><br>Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface<br><br>0.0.0.0         42.1.43.1       0.0.0.0         UG        0 0          0 bond0<br><br>42.1.43.0       0.0.0.0         255.255.255.0   U         0 0          0 bond0<br><br>169.254.0.0     0.0.0.0         255.255.0.0     U         0 0          0 bond0<br><br> <br><br> <br><br><br>3. .201, .101 두 장비의 sosreport 도 수집 부탁드리겠습니다.<br><br>→ 두 서버에 대한 sosreoprt 파일 첨부드립니다<br><br><publishedDate>2019-03-25T01:03:51Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0a2K00000Pa1dsQAB"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-22T07:21:43Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-22T07:21:43Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Services를 이용해주셔서 감사합니다.<br><br>이슈 분석을 위해 아래의 질문에 답변 부탁드립니다.<br><br><br>1. L4 포워딩할때의 라우팅 경로가 어떻게 되는지 확인 부탁드리겠습니다. <br>  (.201 -&gt; .101 포워딩할시 어떤 장비를 거치게 되는지)<br><br>2. 패킷 덤프를 보면 .101 장비가 syn 패킷을 42.1.43.1 로 부터 받는 것으로 보입니다.<br>   &quot;42.1.43.1&quot; 가 무슨 장비인지 확인 바랍니다.<br><br>3. .201, .101 두 장비의 sosreport 도 수집 부탁드리겠습니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-22T07:21:43Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0a2K00000PZzVzQAL"><br>======================<br><b>생성계정 : Li, Xingbin</b><br><b>생성날짜 : 2019-03-22T03:16:25Z</b><br><b>마지막 답변자 : Li, Xingbin</b><br><b>마지막 수정 일자 : 2019-03-22T03:16:25Z</b><br><br>안녕하세요,<br><br>Red Hat Global Support Service 를 이용해주셔서 감사합니다.<br><br>저는 Platform Support 를 담당하고 있는 Technical Support Engineer 이성빈입니다.<br>올려주신 문의내용은 현재 자세히 살펴보고 있는중이며, 관련된 내용이 확인이 되는대로 업데이트 드리도록 하겠습니다.<br><br>감사합니다.<br><br><publishedDate>2019-03-22T03:16:25Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>
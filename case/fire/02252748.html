======================<br><b>생성계정 : support os</b><br><b>생성날짜 : 2018-11-14T06:29:30Z</b><br><b>마지막 답변자 : GSS Tools</b><br><b>마지막 수정 일자 : 2018-12-05T11:07:05Z</b><br><b>id : 500A000000ceL51IAE</b><br>======================<br><br><b><font size=15>
제목  : [삼성화재][aiopsvct01][kubernetes]  시스템이 Nov 13 16:32:40 경에 oom 발생하면서 reboot  이 되었습니다.
</font></b><br><br>======================<br><b>사전문의<br></b><br>어떤 문제/오류/결함이 발생했습니까? 기대하시는 결과는 무엇입니까?<br><br>oom 이 발생한 원인을 확인하고 싶습니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.4</b><br><b>타입  : Defect / Bug</b><br><b>계정 번호  : 1596892</b><br><b>심각도  : 3 (Normal)</b><br><hostname>[삼성화재] aiopsvct01</hostname><br><br><br><comment id="a0a2K00000OMY0QQAX"><br>======================<br><b>생성계정 : Song, Chang-An</b><br><b>생성날짜 : 2018-11-19T07:53:25Z</b><br><b>마지막 답변자 : Song, Chang-An</b><br><b>마지막 수정 일자 : 2018-11-19T07:53:24Z</b><br><br>안녕하세요? Red Hat 송 창 안 입니다.<br><br>확인된 내용에 대해서 업데이트 하도록 하겠습니다.<br>먼저,  제일 마지막 추적 상황으로 판단한 결과, 아래의 유사 사례에 영향이 있을 것으로 판단 하고 있습니다.<br><br>crash in ip6_route_dev_notify <br>https://bugzilla.redhat.com/show_bug.cgi?id=1595097<br><br>&quot;Both RHEL7.4 and RHEL7.5 kernels are affected.&quot;<br><br>이 사례인 경우, RHEL 7.6 이상 업데이트가 필요 하며,  RHEL 7.6버전에서 배포한 커널 버젼은 <br>kernel-3.10.0-957.el7 입니다.<br><br>RHEL7에 대해서 최신으로 업데이트 후,  다시 상황이 발생 하게 되면, 다시 core 파일을 제공해 주시면, <br>확인 후 다시 업데이트 하도록 하겠습니다.<br><br>하지만 현재 시스템에 대해서 확인 결과, RHEL 서브크립션 이외에 다른 제품에 대해서는 기술 지원 범위에 벗어나며, <br>컨테이너 기반 소프트웨어의 배포 및 관리를 위한 소프트웨어 제품을 구매 하신 후, 해당하는 구성을 하신 하셔야, 원활한 기술 지원이 가능합니다.<br>현재는 매우 제한적인 기술 지원만 가능함을 알려 드립니다. <br><br>아래 내용은 dump 파일을 분석 한 내용입니다.<br><br>새로운 Namespace를 생성하는 과정에서, create_new_namespaces가 불리면서,  초기화 과정 중<br>ip6_route_dev_notify 함수에서 세마포어에 대해서 lock 생성/해제 과정에서 이슈가 발생 되었을 것으로 판단 하고 있습니다.<br><br>crash&gt; bt<br>PID: 50612  TASK: ffff881ff1614f10  CPU: 1   COMMAND: &quot;runc:[1:CHILD]&quot;<br> #0 [ffff881a9df5f938] machine_kexec at ffffffff8105c4cb<br> #1 [ffff881a9df5f998] __crash_kexec at ffffffff81104a32<br> #2 [ffff881a9df5fa68] crash_kexec at ffffffff81104b20<br> #3 [ffff881a9df5fa80] oops_end at ffffffff816ad278<br> #4 [ffff881a9df5faa8] no_context at ffffffff8169d29a<br> #5 [ffff881a9df5faf8] __bad_area_nosemaphore at ffffffff8169d330<br> #6 [ffff881a9df5fb40] bad_area_nosemaphore at ffffffff8169d49a<br> #7 [ffff881a9df5fb50] __do_page_fault at ffffffff816b013e<br> #8 [ffff881a9df5fbb0] do_page_fault at ffffffff816b02e5<br> #9 [ffff881a9df5fbe0] page_fault at ffffffff816ac508<br>    [exception RIP: ip6_route_dev_notify+214]   &lt;---------------<br>    RIP: ffffffff81650146  RSP: ffff881a9df5fc90  RFLAGS: 00010246<br>    RAX: ffff880299aef000  RBX: ffff8802df301440  RCX: 0000000000000000<br>    RDX: ffff881a9df5fd18  RSI: 0000000000000006  RDI: 0000000000000000<br>    RBP: ffff881a9df5fc98   R8: ffffffff81b1caa0   R9: 0000000000000002<br>    R10: 0000000000000000  R11: 0000000000000000  R12: 0000000000000000<br>    R13: 0000000000000006  R14: ffff881a9df5fd18  R15: 0000000000000000<br>    ORIG_RAX: ffffffffffffffff  CS: 0010  SS: 0018<br>#10 [ffff881a9df5fca0] notifier_call_chain at ffffffff816b04dc<br>#11 [ffff881a9df5fcd8] raw_notifier_call_chain at ffffffff810b68d6<br>#12 [ffff881a9df5fce8] call_netdevice_notifiers_info at ffffffff8158306d<br>#13 [ffff881a9df5fd10] rollback_registered_many at ffffffff815838c9<br>#14 [ffff881a9df5fd60] rollback_registered at ffffffff81583a60<br>#15 [ffff881a9df5fd90] register_netdevice at ffffffff8158c58f<br>#16 [ffff881a9df5fdc8] register_netdev at ffffffff8158c65a<br>#17 [ffff881a9df5fde0] loopback_net_init at ffffffff8147e2da<br>#18 [ffff881a9df5fe08] ops_init at ffffffff8157cbe1<br>#19 [ffff881a9df5fe48] setup_net at ffffffff8157cd93<br>#20 [ffff881a9df5fe90] copy_net_ns at ffffffff8157d6f5<br>#21 [ffff881a9df5fec0] create_new_namespaces at ffffffff810b5979<br>#22 [ffff881a9df5fef8] unshare_nsproxy_namespaces at ffffffff810b5bba<br>#23 [ffff881a9df5ff28] sys_unshare at ffffffff81086f03<br>#24 [ffff881a9df5ff80] system_call_fastpath at ffffffff816b4fc9<br>    RIP: 00007f35a1636d17  RSP: 00007ffcf48327c8  RFLAGS: 00010212<br>    RAX: 0000000000000110  RBX: ffffffff816b4fc9  RCX: 000000003b108bda<br>    RDX: 0000000000000000  RSI: 000056305e6ede7a  RDI: 000000006c020000<br>    RBP: 0000000000000000   R8: 0000000000000000   R9: 0000000000000000<br>    R10: 00007ffcf4832840  R11: 0000000000000206  R12: 000000006c020000<br>    R13: 0000000000000000  R14: 0000000000000000  R15: 0000000000000000<br>    ORIG_RAX: 0000000000000110  CS: 0033  SS: 002b<br><br>     287 <br>idev = rcu_dereference(dev-&gt;ip6_ptr);<br>0xffffffff81650112 &lt;ip6_route_dev_notify+162&gt;:<br>mov    0x278(%rax),%rax<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/include/net/addrconf.h: 288<br>     288 <br>if (idev)<br>     289 <br><br>atomic_inc(&amp;idev-&gt;refcnt);<br>0xffffffff81650119 &lt;ip6_route_dev_notify+169&gt;:<br>test   %rax,%rax<br>0xffffffff8165011c &lt;ip6_route_dev_notify+172&gt;:<br>je     0xffffffff81650125 &lt;ip6_route_dev_notify+181&gt;<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/arch/x86/include/asm/atomic.h: 96<br>      96 <br>asm volatile(LOCK_PREFIX &quot;incl %0&quot;<br>      97 <br><br>     : &quot;+m&quot; (v-&gt;counter));<br>0xffffffff8165011e &lt;ip6_route_dev_notify+174&gt;:<br>lock incl 0x150(%rax)<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/net/ipv6/route.c: 3396<br>    3396 <br><br>net-&gt;ipv6.ip6_blk_hole_entry-&gt;rt6i_idev = in6_dev_get(dev);<br>0xffffffff81650125 &lt;ip6_route_dev_notify+181&gt;:<br>mov    %rax,0x148(%rdx)<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/net/ipv6/route.c: 3407<br>    3407 }<br>0xffffffff8165012c &lt;ip6_route_dev_notify+188&gt;:<br>mov    $0x1,%eax<br>0xffffffff81650131 &lt;ip6_route_dev_notify+193&gt;:<br>pop    %rbx<br>0xffffffff81650132 &lt;ip6_route_dev_notify+194&gt;:<br>pop    %rbp<br>0xffffffff81650133 &lt;ip6_route_dev_notify+195&gt;:<br>retq   <br>0xffffffff81650134 &lt;ip6_route_dev_notify+196&gt;:<br>nopl   0x0(%rax)<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/net/ipv6/route.c: 3399<br>    3399 <br><br>in6_dev_put(net-&gt;ipv6.ip6_null_entry-&gt;rt6i_idev);<br>0xffffffff81650138 &lt;ip6_route_dev_notify+200&gt;:<br>mov    0x528(%rbx),%rax<br>0xffffffff8165013f &lt;ip6_route_dev_notify+207&gt;:<br>mov    0x148(%rax),%rdi<br>/usr/src/debug/kernel-3.10.0-693.el7/linux-3.10.0-693.el7.x86_64/arch/x86/include/asm/atomic.h: 124<br>     124 <br>asm volatile(LOCK_PREFIX &quot;decl %0; sete %1&quot;<br>     125 <br><br>     : &quot;+m&quot; (v-&gt;counter), &quot;=qm&quot; (c)<br>     126 <br><br>     : : &quot;memory&quot;);<br>0xffffffff81650146 &lt;ip6_route_dev_notify+214&gt;:<br>lock decl 0x150(%rdi)<br><br>또한, OOM killer 프로세스가 실행되는 빈도 확인한 결과,  아래와 같이 실행 된것을 확인 하였습니다. 많은 OOM이 발생하는 것으로 판단이 됩니다.<br><br>crash&gt; log | grep &quot;Memory cgroup out of memory&quot;<br>...<br>[2955587.224537] Memory cgroup out of memory: Kill process 50424 (pause) score 0 or sacrifice child<br>[2955587.246346] Memory cgroup out of memory: Kill process 50596 (perl) score 0 or sacrifice child<br>[2955587.279444] Memory cgroup out of memory: Kill process 50616 (perl) score 0 or sacrifice child<br><br><br>crash&gt; log | grep total-vm<br>[2949996.132096] Killed process 174624 (dpkg-query) total-vm:7044kB, anon-rss:384kB, file-rss:572kB, shmem-rss:0kB<br>[2949996.202267] Killed process 174628 (python) total-vm:27688kB, anon-rss:5268kB, file-rss:2760kB, shmem-rss:0kB<br>[2949996.555910] Killed process 174632 (lsb_release) total-vm:29812kB, anon-rss:5764kB, file-rss:144kB, shmem-rss:0kB<br>[2949996.625478] Killed process 174636 (python) total-vm:27432kB, anon-rss:5268kB, file-rss:2760kB, shmem-rss:0kB<br>[2949996.977788] Killed process 174642 (lsb_release) total-vm:29784kB, anon-rss:5772kB, file-rss:144kB, shmem-rss:0kB<br>[2949997.268037] Killed process 174646 (python) total-vm:27064kB, anon-rss:4788kB, file-rss:2668kB, shmem-rss:0kB<br>[2949997.671353] Killed process 174647 (python) total-vm:94844kB, anon-rss:29480kB, file-rss:4744kB, shmem-rss:0kB<br>[2950260.545875] Killed process 172625 (pause) total-vm:1012kB, anon-rss:4kB, file-rss:0kB, shmem-rss:0kB<br>[2950260.562431] Killed process 177569 (cc1) total-vm:49192kB, anon-rss:4164kB, file-rss:3932kB, shmem-rss:0kB<br>[2950260.973565] Killed process 177616 (python) total-vm:67808kB, anon-rss:22028kB, file-rss:4288kB, shmem-rss:0kB<br>[2950302.979292] Killed process 174733 (pause) total-vm:1012kB, anon-rss:4kB, file-rss:0kB, shmem-rss:0kB<br>[2950302.991152] Killed process 178659 (lsb_release) total-vm:27124kB, anon-rss:4692kB, file-rss:2728kB, shmem-rss:0kB<br>[2950303.018142] Killed process 178666 (lsb_release) total-vm:26416kB, anon-rss:4128kB, file-rss:2644kB, shmem-rss:0kB<br>[2950303.337903] Killed process 178694 (lsb_release) total-vm:29812kB, anon-rss:5768kB, file-rss:144kB, shmem-rss:0kB<br>....<br><br>kdump가 수행된 시간에 제일 많이 소비된 태스크 리스트를 확인 한 내용입니다.<br><br>crash&gt; ps -G | sed 's/^&gt;//' | awk '{ m[$9]+=$8/1024 } END { for (item in m) { printf &quot;%20s %10s MiB\n&quot;, item, m[item] } }' | sort -k 2 -r -n | head<br>              python    954.438 MiB<br>     docker-containe     137.93 MiB<br>              oacore    118.176 MiB<br>             kubelet     115.23 MiB<br>            midaemon    87.1562 MiB<br>                java    70.9844 MiB<br>             dockerd     62.293 MiB<br>           weave-npc    47.7344 MiB<br>              weaver    44.7344 MiB<br>            hpsensor    33.8047 MiB<br><br>OOM killer 이후로 메모리 영역은 해소 된것으로 파악이 됩니다.<br>crash&gt; kmem -z | grep -A30 Normal | egrep &quot;SIZE|FREE&quot;<br>  SIZE: 15990784  MIN/LOW/HIGH: 5493/6866/8239<br>                NR_FREE_PAGES: 1876189<br>  SIZE: 16777215  MIN/LOW/HIGH: 5767/7208/8650<br>                NR_FREE_PAGES: 11935199<br><br>메모리 상태는 OOM 발생 후,  52 GB 정도의 free 영역이 확보 된것으로 판단 하고 있습니다.<br>crash&gt; kmem -i<br>                 PAGES        TOTAL      PERCENTAGE<br>    TOTAL MEM  32793919     125.1 GB         ----<br>         FREE  13876999      52.9 GB   42% of TOTAL MEM<br>         USED  18916920      72.2 GB   57% of TOTAL MEM<br>       SHARED  13515731      51.6 GB   41% of TOTAL MEM<br>      BUFFERS     1291         5 MB    0% of TOTAL MEM<br>       CACHED  16413802      62.6 GB   50% of TOTAL MEM<br>         SLAB  1732608       6.6 GB    5% of TOTAL MEM<br><br>   TOTAL HUGE        0            0         ----<br>    HUGE FREE        0            0    0% of TOTAL HUGE<br><br>   TOTAL SWAP        0            0         ----<br>    SWAP USED        0            0    0% of TOTAL SWAP<br>    SWAP FREE        0            0    0% of TOTAL SWAP<br><br> COMMIT LIMIT  16396959      62.5 GB         ----<br>    COMMITTED  3337322      12.7 GB   20% of TOTAL LIMIT<br>crash&gt; <br><br>감사합니다.<br>송 창 안 드림.<br><br><publishedDate>2018-11-19T07:53:24Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O9ZA6IAN"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2018-11-16T05:44:35Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2018-11-16T05:44:34Z</b><br><br>02252748-vmcore-20181116-1 이름으로 dropbox.redhat. com 으로 파일 업로드 했습니다.<br><br><publishedDate>2018-11-16T05:44:34Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O9Hf4IAF"><br>======================<br><b>생성계정 : Song, Chang-An</b><br><b>생성날짜 : 2018-11-15T07:39:17Z</b><br><b>마지막 답변자 : Song, Chang-An</b><br><b>마지막 수정 일자 : 2018-11-15T07:39:17Z</b><br><br>안녕하세요? Red Hat 송 창 안 입니다.<br><br>유선상으로 설명 해드린 내용과 같이 vmcore 파일을 한번 더 확인후 다시 공유 해주시길 부탁드립니다.<br><br>감사합니다.<br>송 창 안 드림.<br><br><publishedDate>2018-11-15T07:39:17Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O9EA7IAN"><br>======================<br><b>생성계정 : Song, Chang-An</b><br><b>생성날짜 : 2018-11-15T01:36:15Z</b><br><b>마지막 답변자 : Song, Chang-An</b><br><b>마지막 수정 일자 : 2018-11-15T01:36:15Z</b><br><br>안녕하세요? Red Hat 송 창 안 입니다.<br><br>공유 해주신 정보를 확인 후 업데이트 하도록 하겠습니다.<br><br>송 창 안 드림.<br><br><publishedDate>2018-11-15T01:36:15Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000O8y5TIAR"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2018-11-14T08:41:38Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2018-11-14T08:41:38Z</b><br><br>dropbox.redhat.com 에<br>02252748-vmcore 파일을 업로그 했습니다.<br><br><publishedDate>2018-11-14T08:41:38Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000O8wMIIAZ"><br>======================<br><b>생성계정 : os, support</b><br><b>생성날짜 : 2018-11-14T06:43:44Z</b><br><b>마지막 답변자 : os, support</b><br><b>마지막 수정 일자 : 2018-11-14T06:43:43Z</b><br><br>vmcore  파일은 02252748-vmcore 이름으로 업로드 하겠습니다.<br><br><publishedDate>2018-11-14T06:43:43Z</publishedDate><createdByType>Customer</createdByType><br>======================<br></comments><br>
======================<br><b>생성계정 : jimin kim</b><br><b>생성날짜 : 2018-05-08T01:28:29Z</b><br><b>마지막 답변자 : GSS Tools</b><br><b>마지막 수정 일자 : 2018-05-30T10:04:02Z</b><br><b>id : 500A000000aRWg4IAG</b><br>======================<br><br><b><font size=15>
제목  : NTP 동기화 설정 관련 문의
</font></b><br><br>======================<br><b>사전문의<br></b><br>안녕하세요<br><br>SDS 김지민 선임입니다.<br><br>RHEL5/6/7 버전의 NTP 관련해서 문의를 드리려고 합니다.<br><br>PM 작업으로 인하여 리부팅된 서버가 한대 있었었는데<br>HW 시간으로 인하여 NTP 동기화에 실패한 서버가 있었습니다.<br><br>부팅 시에 NTP 서비스를 통해서 시간을 맞추기는 하지만<br>추가로 /etc/sysconfig/ntpd에 설정을 추가하거나 <br>다른 방법을 통해서 NTP 서버와 한번 더 동기화 후 <br>서비스가 가능한 방법이있는지 문의드리려고 합니다.<br><br>감사합니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>타입  : Other</b><br><b>계정 번호  : 5251314</b><br><b>심각도  : 3 (Normal)</b><br><hostname>SLPAFIDL01</hostname><br><br><br><comment id="a0aA000000Mc1DNIAZ"><br>======================<br><b>생성계정 : Huh, Kyung</b><br><b>생성날짜 : 2018-05-10T02:05:21Z</b><br><b>마지막 답변자 : Huh, Kyung</b><br><b>마지막 수정 일자 : 2018-05-10T02:05:21Z</b><br><br>안녕하세요? 레드햇 허경입니다.<br><br>ntpdate 서비스는 시스팀 시작시 ntp로부터 시간을 가져와서 시스템에 한번만 적용합니다. SYNC_HWCLOCK=yes 옵션이 적용되면 Hardware Clock을 먼저 동기화 한 후 System Clock을 동기화 하게 됩니다.<br>이미 알고 계시듯이 지속적인 동기화는 하지 않습니다.<br><br>이에 반해 ntpd 서비스는 지속적인 시간 동기화를 제공하는 서비스 입니다. /etc/sysconfig/ntpd 에 SYNC_HWCLOCK 옵션은 RHEL5에서 적용할 때 사용방법입니다.<br>RHEL6, RHEL7 버전의 경우 /etc/sysconfig/ntpdate 설정 파일에만 SYNC_HWCLOCK 옵션을 적용하실 수 있습니다.<br><br>지금 현재 /etc/sysconfig/ntpd 파일에 적용되어 있는 설정을 보면 -g 옵션이 적용되어 있는데 offset이 panic theshold를 초과할때 시스템에 메시지를 기록하고 종료하는 옵션입니다. 따라서, ntpd -qg 옵션처럼 한번 실행하는 목적으로 사용하는 옵션이기 때문에 /etc/sysconfig/ntpd 설정에 포함하지 않는 것이 좋을 것 같습니다.<br><br>500 PPM 로그 메시지의 경우 https://access.redhat.com/solutions/35640 문서에서 설명하는 내용중에  VM의 경우 /etc/ntp.conf 설정 파일 가장 위쪽에 아래 항목 추가에 대한 언급이 있습니다.<br><br>tinker panic 0 <br><br>이 설정을 추가한 후 ntpd를 재시작하면 문제가 해소될 것으로 보입니다.<br><br>참고로, drift 파일은 ntpd가 자동으로 생성하는 파일이기 때문에 수동으로 변경하시는 것은 의미가 없습니다.<br>ntp.conf 에 아래와 같은 항목으로 변경가능합니다.<br><br>tinker freq &lt;수치&gt;<br><br>관련한 상세 옵션은 아래 문서를 참고하시기 바랍니다.<br><br>http://doc.ntp.org/4.2.8/miscopt.html#tinker<br> <br>허 경 드림.<br><br>Regards,<br>Kyung Huh<br>Sr. Technical Account Manager<br>Customer Experience &amp; Engagement<br><br><publishedDate>2018-05-10T02:05:21Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000MbjsmIAB"><br>======================<br><b>생성계정 : kim, jimin</b><br><b>생성날짜 : 2018-05-09T05:02:44Z</b><br><b>마지막 답변자 : kim, jimin</b><br><b>마지막 수정 일자 : 2018-05-09T05:02:44Z</b><br><br>추가 문의드립니다.<br><br>frequency error 로그로 모니터링을 하다보니, ntpq 쿼리로 확인한 offset 이 크지 않은데, 지속적으로 해당 메시지를 뿌리고 있는 서버들이 일부 있습니다.<br><br>root@PDBEAL03SL /root # ntpq -p<br>     remote           refid      st t when poll reach   delay   offset  jitter<br>==============================================================================<br>*PNTPML01SL      .GPS.            1 u   63   64  377    0.471    0.384   0.971<br>+PNTPML02SL      .GPS.            1 u   60   64  377    0.466    0.371   0.040<br><br>root@PDBEAL03SL /root # grep freq /var/log/messages | tail<br>May  9 13:10:27 PDBEAL03SL ntpd[3051]: frequency error 500 PPM exceeds tolerance 500 PPM<br>May  9 13:17:03 PDBEAL03SL ntpd[3051]: frequency error 500 PPM exceeds tolerance 500 PPM<br>May  9 13:18:10 PDBEAL03SL ntpd[3051]: frequency error 500 PPM exceeds tolerance 500 PPM<br><br>찍어주신 아래 링크에 있는 방법대로 조치를 할수 있는 상황인건지. 확인부탁드려요.<br>https://access.redhat.com/solutions/35640<br><br>굳이 시간 동기화에 큰 이슈가 없으면 해당 메시지를 안나오게 하고 싶은데.. <br>500 PPM 임계치를 상향조정하는 방법이 있는지 가이드 부탁드립니다.<br><br>참고로 아래 값에 500이 명시되어 있던데 이 값을 조정해도 되는건지 궁금합니다.<br>root@PDBEAL03SL /root # cat /var/lib/ntp/drift<br>500.000<br><br><publishedDate>2018-05-09T05:02:44Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000MbiAJIAZ"><br>======================<br><b>생성계정 : kim, jimin</b><br><b>생성날짜 : 2018-05-09T01:09:42Z</b><br><b>마지막 답변자 : kim, jimin</b><br><b>마지막 수정 일자 : 2018-05-09T01:09:41Z</b><br><br>안녕하세요<br><br>SDS 김지민 선임입니다.<br><br>아래와 같이 설정이 되어있는 서버가 있습니다.<br><br>root@PQUOAL15SL /root # cat /etc/redhat-release<br>Red Hat Enterprise Linux Server release 7.2 (Maipo)<br><br>설정 값들과 ntpdate.service와 ntpd.service를 확인해봤을 때<br><br>부팅 시에 절차는 아래와 같을 것 같은데 문의드립니다.<br><br>1. ntpdate.service에 의해서 /etc/sysconfig/ntpdate option 기반으로 /etc/ntp/step-tickers의 PNTPML01SL과 동기화를 하고 exited<br>   (SYNC_HWCLOCK-=yes option에 의해서 HW 시간을 시스템(OS)의 시간에 맞춤)<br><br>2. ntpd.service 가동되면서 /etc/sysconfig/ntpd option 기반으로 가동 <br><br> - 한가지 문의드릴 점은 /etc/sysconfig/ntpd의 SYNC_HWCLOCK=yes과 /etc/sysconfig/ntpdate의 SYNC_HWCLOCK=yes의 동작이 다른 것인지도 문의드립니다. 문서 내용을 보면 ntpdate의 경우에 SYNC_HWCLOCK이 yes면 HW의 시간을 system(OS) 시간과 맞추는 것 처럼 보여서 문의드립니다. <br><br>[설정 내용]<br><br>root@PQUOAL15SL /root # cat /etc/sysconfig/ntpd<br># Command line options for ntpd<br>OPTIONS=&quot;-g -4 -x&quot;<br><br>       -g      Normally, ntpd exits with a message to the system log if the  offset  exceeds  the<br>               panic threshold, which is 1000 s by default. This option allows the time to be set<br>               to any value without restriction; however, this  can  happen  only  once.  If  the<br>               threshold is exceeded after that, ntpd will exit with a message to the system log.<br>               This option can be used with the -q and -x options. See  the  tinker  command  for<br>               other options.<br><br>       -4      Force DNS resolution of host names to the IPv4 namespace.<br><br>       -x      Normally, the time is slewed if the offset is less than the step threshold,  which<br>               is  128  ms  by  default, and stepped if above the threshold. This option sets the<br>               threshold to 600 s, which is well within the accuracy window to set the clock man-<br>               ually.  Note:  Since the slew rate of typical Unix kernels is limited to 0.5 ms/s,<br>               each second of adjustment requires an amortization interval of 2000  s.  Thus,  an<br>               adjustment  as much as 600 s will take almost 14 days to complete. This option can<br>               be used with the -g and -q options. See the  tinker  command  for  other  options.<br>               Note: The kernel time discipline is disabled with this option and the step thresh-<br>               old is applied also to leap second corrections.<br><br>root@PQUOAL15SL /root # cat /etc/sysconfig/ntpdate<br># Options for ntpdate<br># OPTIONS=&quot;-p 2&quot;<br>OPTIONS=&quot;-p 2 -4&quot;<br><br># Number of retries before giving up<br>RETRIES=2<br><br># Set to 'yes' to sync hw clock after successful ntpdate<br># SYNC_HWCLOCK=no<br>SYNC_HWCLOCK=yes<br><br>       -p samples<br>               Specify the number of samples to be acquired from each server as the integer  sam-<br>               ples, with values from 1 to 8 inclusive. The default is 4.<br><br>       -4      Force  DNS  resolution  of  following  host  names on the command line to the IPv4<br>               namespace.<br><br>root@PQUOAL15SL /root # cat /etc/ntp/step-tickers<br># List of NTP servers used by the ntpdate service.<br><br># 0.rhel.pool.ntp.org<br>PNTPML01SL<br><br> - systemctl 상태<br><br>root@PQUOAL15SL / # systemctl status ntpdate.service<br>* ntpdate.service - Set time via NTP<br>   Loaded: loaded (/usr/lib/systemd/system/ntpdate.service; enabled; vendor preset: disabled)<br>   Active: active (exited) since Sun 2018-05-06 14:23:31 KST; 2 days ago<br>  Process: 2830 ExecStart=/usr/libexec/ntpdate-wrapper (code=exited, status=0/SUCCESS)<br> Main PID: 2830 (code=exited, status=0/SUCCESS)<br>   CGroup: /system.slice/ntpdate.service<br><br>May 06 14:23:29 PQUOAL15SL ntpdate[2861]: step time server 100.254.147.100 offset -0.450790 sec<br><br>root@PQUOAL15SL / # systemctl status ntpd.service<br>* ntpd.service - Network Time Service<br>   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Sun 2018-05-06 14:23:31 KST; 2 days ago<br>  Process: 4705 ExecStart=/usr/sbin/ntpd -u ntp:ntp $OPTIONS (code=exited, status=0/SUCCESS)<br> Main PID: 4708 (ntpd)<br>   CGroup: /system.slice/ntpd.service<br>           `-4708 /usr/sbin/ntpd -u ntp:ntp -g -4 -x<br><br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: 0.0.0.0 c01d 0d kern kernel time sync enabled<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: ntp_io: estimated max descriptors: 1024, initial socke...: 16<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: Listen and drop on 0 v4wildcard 0.0.0.0 UDP 123<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: Listen normally on 1 lo 127.0.0.1 UDP 123<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: Listen normally on 2 bond0 100.254.142.65 UDP 123<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: Listen normally on 3 bond1 172.18.12.65 UDP 123<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: Listening on routing socket on fd #20 for interface updates<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: 0.0.0.0 c016 06 restart<br>May 06 14:23:31 PQUOAL15SL ntpd[4708]: 0.0.0.0 c012 02 freq_set ntpd -6.810 PPM<br>May 06 14:26:46 PQUOAL15SL ntpd[4708]: 0.0.0.0 c615 05 clock_sync<br>Hint: Some lines were ellipsized, use -l to show in full.<br><br>감사합니다.<br><br><publishedDate>2018-05-09T01:09:41Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000MbTDAIA3"><br>======================<br><b>생성계정 : Huh, Kyung</b><br><b>생성날짜 : 2018-05-08T07:58:30Z</b><br><b>마지막 답변자 : Huh, Kyung</b><br><b>마지막 수정 일자 : 2018-05-08T07:58:30Z</b><br><br>안녕하세요? 레드햇 허경입니다.<br><br>NTP 관련해서 많은 KCS 문서들이 있습니다. 답변에 포함된 문서들을 주의깊게 읽어보시면 도움이 되실 것 같습니다.<br><br>Regards,<br>Kyung Huh<br>Sr. Technical Account Manager<br>Customer Experience &amp; Engagement<br><br><br>(In reply to kim, jimin)<br>&gt; 안녕하세요<br>&gt; <br>&gt; 빠른 답변 감사드립니다.<br>&gt; <br>&gt; 추가로 몇가지 문의를 더 드립니다.<br>&gt; <br>&gt; 1. 일단 그럼 HW(BIOS) 시간이 잘 설정이 되어있어야 초반에 Hardware clock 동기화로 조금이라도 맞추고 ntp sync를 하게되는 것인가요? 이럴 경우 만약 Hardware clock이 잘못 설정되어있을 경우 잘못되지 않을지 해서 문의드립니다.<br>네, 맞습니다. NTP로부터 hardware clock을 먼저 동기화 한 후 system clock을 동기화 하는 것입니다. Hardware clock을 먼저 맞추는 작업을 하는 것이기 때문에 잘못 설정되어 있을 경우 먼저 시간을 맞추게 됩니다.<br><br>앞서 알려드린 KCS 문서에 아래와 같은 언급이 있습니다.<br><br>If SYNC_HWCLOCK=yes is used in /etc/sysconfig/ntpd, it means when the ntpd is started, it will first sync with hardware clock, that will reduce the offset and skew between the two clocks.<br><br><br>&gt; 2. esx 기반 가상 서버일 경우에는 host와 동기화를 할 것같은데 이부분에 있어서도 <br>&gt;    SYNC_HWCLOCK=yes  option이 적용이되는지 문의드립니다.<br>&gt; <br>이 부분은 확인이 필요합니다만, 가상 시스템은 실제로 Hardware clock이 없기 때문에 호스트에서 제공하는 시간으로 동기화 됩니다.<br>ESX 기반 가상 머신에 대한 부분은 아래 두 문서를 참고하시기 바랍니다. 또한 VMWare에서 제공하는 문서도 확인하시기 바랍니다.<br><br>https://access.redhat.com/solutions/278273<br>https://www.redhat.com/en/blog/avoiding-clock-drift-vms<br><br>&gt; 3. 이번 문제가 발생한 서버에서 아래와 같이 에러가 발생하였는데요.<br>&gt; 혹시 PPM의 단위에 대해서 문의드리려고 합니다.<br>&gt; frequency error -554 PPM exceeds tolerance 500 PPM <br>&gt; <br><br>PPM은 Part Per Million의 약자입니다.<br>이 오류 메시지는 ntpd의 시간과 시스템 clock의 시간의 차가 500 PPM 이상 차이가 날 경우에 기록되는 것입니다.<br> <br>The time computed by ntpd and the one reported by the systems internal clock exceeds 500 PPM would lead to the observed log messages. If the difference exceeds 500 parts-per-million (0.0005%) over the synchronization interval then the log message appears.<br><br>아래와 같은 방법으로 해결할 수 있습니다.<br><br># service ntpd stop<br># ntpd -qg<br># service ntpd start<br><br>상세한 내용은 아래 문서를 참고하시기 바랍니다.<br><br>https://access.redhat.com/solutions/35640<br><br><br>&gt; 감사합니다.<br><br><publishedDate>2018-05-08T07:58:30Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000MbSVwIAN"><br>======================<br><b>생성계정 : kim, jimin</b><br><b>생성날짜 : 2018-05-08T07:01:49Z</b><br><b>마지막 답변자 : kim, jimin</b><br><b>마지막 수정 일자 : 2018-05-08T07:01:49Z</b><br><br>안녕하세요<br><br>빠른 답변 감사드립니다.<br><br>추가로 몇가지 문의를 더 드립니다.<br><br>1. 일단 그럼 HW(BIOS) 시간이 잘 설정이 되어있어야 초반에 Hardware clock 동기화로 조금이라도 맞추고 ntp sync를 하게되는 것인가요? 이럴 경우 만약 Hardware clock이 잘못 설정되어있을 경우 잘못되지 않을지 해서 문의드립니다.<br><br>2. esx 기반 가상 서버일 경우에는 host와 동기화를 할 것같은데 이부분에 있어서도 <br>   SYNC_HWCLOCK=yes  option이 적용이되는지 문의드립니다.<br><br>3. 이번 문제가 발생한 서버에서 아래와 같이 에러가 발생하였는데요.<br>혹시 PPM의 단위에 대해서 문의드리려고 합니다.<br>frequency error -554 PPM exceeds tolerance 500 PPM <br><br>감사합니다.<br><br><publishedDate>2018-05-08T07:01:49Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000MbRPpIAN"><br>======================<br><b>생성계정 : Huh, Kyung</b><br><b>생성날짜 : 2018-05-08T05:18:35Z</b><br><b>마지막 답변자 : Huh, Kyung</b><br><b>마지막 수정 일자 : 2018-05-08T05:18:35Z</b><br><br>안녕하세요? 레드햇 허경입니다.<br><br>Hardware clock 동기화를 할 수 있는 방법이 있습니다.<br>RHEL5와 RHEL6 버전에서 방법이 나와 있는데 RHEL7에서의 방법은 확인하여 알려드리겠습니다.<br><br>SYNC_HWCLOCK=yes 옵션을 적용하는데,<br>RHEL5의 경우 /etc/sysconfig/ntpd 파일에 적용하고 RHEL6의 경우 /etc/sysconfig/ntpdate에 적용하여 사용하실 수 있습니다.<br><br>How do I make the NTP client sync with the hardware clock on Red Hat Enterprise Linux?<br>https://access.redhat.com/solutions/2649<br><br>허 경 드림.<br><br>Regards,<br>Kyung Huh<br>Sr. Technical Account Manager<br>Customer Experience &amp; Engagement<br><br><publishedDate>2018-05-08T05:18:35Z</publishedDate><createdByType>Associate</createdByType><br>======================<br></comments><br>
======================<br><b>생성계정 : 우택 심</b><br><b>생성날짜 : 2016-02-27T14:28:55Z</b><br><b>마지막 답변자 : JINKOO HAN</b><br><b>마지막 수정 일자 : 2016-03-22T07:54:33Z</b><br><b>id : 500A000000Tdg8rIAB</b><br>======================<br><br><b><font size=15>
제목  : SCSI Scan 방식에 대한 문의
</font></b><br><br>======================<br><b>사전문의<br></b><br>어떤 문제/오류/결함이 발생했습니까? 기대하시는 결과는 무엇입니까?<br><br>안녕하세요.<br><br>Hitachi Storage GAD 가용성 테스트 중 특정 Lun 이 multipath 에서 계속해서 fail 로 나타나는 문제가 발견되어 scsi-rescan 을 통해 정상화를 하였으나, <br><br>몇 가지 차이점이 발견되어 문의 드립니다.<br><br>어디서 문제가 발생했습니까? 어떤 환경에서 발생했습니까?<br><br>테스트 절차는 아래와 같습니다.<br><br>1.  GAD 원장/이중화 컨트롤러 사이에 Replicator 복제라인을 모두 절체 후 원장 컨트롤러만 살아남게 장애유발 (Multipath 에서 절반 Fail Faulty)<br><br>2. I/O 정상 유무 및 Path 장애 확인<br><br>3. GAD Replicator 복제라인 복원 및 스토리지 간 Resync (원장 &lt;-&gt; 이중화)<br><br><br>4. Resync 완료 후 AP 서버(RHEL7) 에서 아래와 같은 명령으로 Scan<br>for i in $(ls /sys/class/scsi_host)<br>do<br>        echo &quot;- - -&quot; &gt; /sys/class/scsi_host/${i}/scan<br>done<br><br><br>5. Scan 후 multipath -ll 로 보니 특정  Lun 에 대해 아래와 같은 결과 출력<br># multipath -ll<br>...<br>mpathal (360060e8007c7fb000030c7fb00000c19) dm-22 HITACHI ,OPEN-V<br>size=800G features='1 queue_if_no_path' hwhandler='0' wp=rw<br>`-+- policy='service-time 0' prio=1 status=active<br>  |- 1:0:1:36 sdei 128:160 active ready running<br>  |- 4:0:1:36 sdej 128:176 active ready running<br>  |- 1:0:0:30 sdii 135:32  failed ready running<br>  `- 4:0:0:30 sdjk 8:480   active ready running<br>...<br><br><br>6. 동일한 방법으로 재스캔 및 Multipath reload 도 해 보았으나 해결 안됨.<br><br>7. scsi-rescan -i 방법으로 다시 시도<br><br>8. 아래와 같이 multipath 정상으로 복원<br># multipath -ll<br>...<br>mpathal (360060e8007c7fb000030c7fb00000c19) dm-22 HITACHI ,OPEN-V<br>size=800G features='1 queue_if_no_path' hwhandler='0' wp=rw<br>`-+- policy='service-time 0' prio=1 status=active<br>  |- 1:0:0:30 sdii 135:32  active ready running<br>  |- 1:0:1:36 sdei 128:160 active ready running<br>  |- 4:0:0:30 sdjk 8:480   active ready running<br>  `- 4:0:1:36 sdej 128:176 active ready running<br>...<br><br>언제 문제가 발생했습니까? 이러한 문제가 자주 발생합니까? 반복적으로 발생합니까? 특정 시간에 발생합니까?<br><br>위와 같이 조치를 하여 모든 path 에 대해 정상화는 했습니다.<br><br>문의 드릴 사항은 위에서 수행했던 두 가지 스캔 방식에 대한 정확한 차이점에 대해 알고 싶습니다.<br><br>만약 운영 도중 dev_loss 가 발생하여 Path 를 복원할 때 위와 같이 2번의 절차를 수행해야 하는지도 확인 부탁드립니다.<br><br>감사합니다.<br>=======================<br><b>상태 : Closed</b><br><b>제품명  : Red Hat Enterprise Linux</b><br><b>버젼  : 7.2</b><br><b>계정 번호  : 5251314</b><br><b>심각도  : 3 (Normal)</b><br><enhancedSLA>false</enhancedSLA><contactIsPartner>false</contactIsPartner><tags/><br><br><comment id="a0aA000000GjEH9IAN"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-03-15T02:27:36Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-03-15T02:27:36Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>우선 'scsi-rescan -i' 명령어는 시스템에 있는 HBAs들의 FibreChanner LIP(Loop Initialization Protocol)를을 리셋하는 수행하게 됩니다. <br>참고로 LIP는 기본적으로 bus reset, device 추가 삭제를 할때 사용됨.<br><br>즉, 현재 상황에서 유추를 할 수 있는 것은 현재 버스내의 device에 SCSI Layer가 업데이트 되지 못함에 따라 multipath에서는 active가 되지 못하고 있다가 'scsi-rescan -i'명령어를 통한 리셋을 통해서 원활한 상태가 된 것으로 유추됩니다.<br><br><br>업무에 참고하여 주시기 바랍니다.<br><br>감사합니다.<br><br><publishedDate>2016-03-15T02:27:36Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gj0YnIAJ"><br>======================<br><b>생성계정 : 심, 우택</b><br><b>생성날짜 : 2016-03-14T06:36:13Z</b><br><b>마지막 답변자 : 심, 우택</b><br><b>마지막 수정 일자 : 2016-03-14T06:36:13Z</b><br><br>안녕하세요.<br><br>SAN 장애 복구 후<br><br>scsi_host/hostX 에 &quot;- - -&quot; 만 해서 refresh 했을 때에는 <br><br>multipath -ll 결과에 특정 일부 LUN path 에 대해 failed ready running 상태로 지속되는 문제가 발견되어 문의 드린 내용 이구요,<br><br>실제로 scsi-rescan -i 명령을 추가로 실행하고 나서 multipath -ll 결과가 모든 path 에 대해 active ready running 로 정상화 되었습니다.<br><br>그래서 scsi-rescan 명령 자체에 multipath 의 LUN path 에 대해 어떤 이벤트를 줄 수 있는 기능이 포함되어 있는지 문의 드렸습니다.<br><br>감사합니다.<br><br><publishedDate>2016-03-14T06:36:13Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000Gj0RNIAZ"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-03-14T06:20:00Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-03-14T06:20:00Z</b><br><br>안녕하세요,<br>Red Hat 한진구 입니다.<br><br>문의주신 내용중에 아래 부분에 대한 설명 부탁드립니다.<br><br>&gt; scsi-rescan 의 경우 multipath 내 LUN 에 대한 refresh 기능이 포함되어 있는 것 같습니다.<br><br><br>이게 어떤 의미이신지요?<br><br>설명 부탁드립니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-03-14T06:20:00Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gizo0IAB"><br>======================<br><b>생성계정 : 심, 우택</b><br><b>생성날짜 : 2016-03-14T04:36:44Z</b><br><b>마지막 답변자 : 심, 우택</b><br><b>마지막 수정 일자 : 2016-03-14T04:36:43Z</b><br><br>안녕하세요.<br><br>우선은 SAN Storage path 장애 후 복구 시 아래와 같은 방법으로 가이드를 진행하였습니다.<br><br># for i in $(ls /sys/class/scsi_host)<br>do<br>echo &quot;- - -&quot; &gt; /sys/class/scsi_host/${i}/scan<br>done<br><br># scsi-rescan -i<br><br>통상 scsi_host 에 &quot;- - -&quot; 값만 넣어도 정상 복원이 되지만, scsi-rescan 의 경우 multipath 내 LUN 에 대한 refresh 기능이 포함되어 있는 것 같습니다.<br><br>이 부분에 대한 확인 부탁 드립니다.<br><br>감사합니다.<br><br><publishedDate>2016-03-14T04:36:43Z</publishedDate><createdByType>Customer</createdByType><br>======================<br><comment id="a0aA000000GaynoIAB"><br>======================<br><b>생성계정 : HAN, JINKOO</b><br><b>생성날짜 : 2016-02-29T00:42:01Z</b><br><b>마지막 답변자 : HAN, JINKOO</b><br><b>마지막 수정 일자 : 2016-02-29T00:42:01Z</b><br><br>안녕하세요,<br>Red Hat Technical Account Manager 한진구 입니다.<br><br>데이터확인을 위해서 아래와 같이 요청드립니다.<br><br>1.sosreport와 <br>2. rescan을 수했던 두시점과 'scsi-rescan -i'을 수행한 시점의 시간 정보도 확인 바랍니다.<br>======================<br>감사합니다.<br><br><publishedDate>2016-02-29T00:42:01Z</publishedDate><createdByType>Associate</createdByType><br>======================<br><comment id="a0aA000000Gasb2IAB"><br>======================<br><b>생성계정 : 심, 우택</b><br><b>생성날짜 : 2016-02-27T14:38:43Z</b><br><b>마지막 답변자 : 심, 우택</b><br><b>마지막 수정 일자 : 2016-02-27T14:38:43Z</b><br><br>scsi-rescan -i 명령을 수행한 후 /var/log/messages 로그를 확인 해 보니 아래와 같이 Multipath 에서 해당 Lun 을 인식했던 내용을 확인 할 수 있었습니다.<br><br># cat /var/log/messages<br>...<br>Feb 27 15:45:38 PQUOAL01SL multipathd: mpathal: sdii - tur checker reports path is up<br>Feb 27 15:45:38 PQUOAL01SL multipathd: 135:32: reinstated<br>Feb 27 15:45:38 PQUOAL01SL multipathd: mpathal: remaining active paths: 4<br>Feb 27 15:45:38 PQUOAL01SL kernel: device-mapper: multipath: Failing path 135:32.<br>Feb 27 15:45:38 PQUOAL01SL multipathd: 135:32: mark as failed<br>Feb 27 15:45:38 PQUOAL01SL multipathd: mpathal: remaining active paths: 3<br>Feb 27 15:45:54 PQUOAL01SL kernel: sd 1:0:0:30: [sdii] 1677721600 512-byte logical blocks: (858 GB/800 GiB)<br>Feb 27 15:45:54 PQUOAL01SL kernel: sd 1:0:0:30: [sdii] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA<br>Feb 27 15:45:54 PQUOAL01SL kernel: sdii: detected capacity change from 0 to 858993459200<br>Feb 27 15:45:54 PQUOAL01SL kernel: sdii: unknown partition table<br>Feb 27 15:45:54 PQUOAL01SL systemd: Device dev-disk-by\x2did-scsi\x2d360060e8007c7fb000030c7fb00000c19.device appeared twice with different sysfs paths /sys/devices/pci0000:80/0000:80:02.0/0000:84:00.1/host4/rport-4:0-1/target4:0:1/4:0:1:36/block/sdej and /sys/devices/pci0000:00/0000:00:03.2/0000:0b:00.0/host1/rport-1:0-0/target1:0:0/1:0:0:30/block/sdii<br>Feb 27 15:45:54 PQUOAL01SL systemd: Device dev-disk-by\x2did-wwn\x2d0x60060e8007c7fb000030c7fb00000c19.device appeared twice with different sysfs paths /sys/devices/pci0000:80/0000:80:02.0/0000:84:00.1/host4/rport-4:0-1/target4:0:1/4:0:1:36/block/sdej and /sys/devices/pci0000:00/0000:00:03.2/0000:0b:00.0/host1/rport-1:0-0/target1:0:0/1:0:0:30/block/sdii<br><br><publishedDate>2016-02-27T14:38:43Z</publishedDate><createdByType>Customer</createdByType><br>======================<br></comments><br><br>Hitachi Storage GAD 가용성 테스트 중 특정 Lun 이 multipath 에서 계속해서 fail 로 나타나는 문제가 발견되어 scsi-rescan 을 통해 정상화를 하였으나, <br><br>몇 가지 차이점이 발견되어 문의 드립니다.</issue><environment>테스트 절차는 아래와 같습니다.<br><br>1.  GAD 원장/이중화 컨트롤러 사이에 Replicator 복제라인을 모두 절체 후 원장 컨트롤러만 살아남게 장애유발 (Multipath 에서 절반 Fail Faulty)<br><br>2. I/O 정상 유무 및 Path 장애 확인<br><br>3. GAD Replicator 복제라인 복원 및 스토리지 간 Resync (원장 &lt;-&gt; 이중화)<br><br><br>4. Resync 완료 후 AP 서버(RHEL7) 에서 아래와 같은 명령으로 Scan<br>for i in $(ls /sys/class/scsi_host)<br>do<br>        echo &quot;- - -&quot; &gt; /sys/class/scsi_host/${i}/scan<br>done<br><br><br>5. Scan 후 multipath -ll 로 보니 특정  Lun 에 대해 아래와 같은 결과 출력<br># multipath -ll<br>...<br>mpathal (360060e8007c7fb000030c7fb00000c19) dm-22 HITACHI ,OPEN-V<br>size=800G features='1 queue_if_no_path' hwhandler='0' wp=rw<br>`-+- policy='service-time 0' prio=1 status=active<br>  |- 1:0:1:36 sdei 128:160 active ready running<br>  |- 4:0:1:36 sdej 128:176 active ready running<br>  |- 1:0:0:30 sdii 135:32  failed ready running<br>  `- 4:0:0:30 sdjk 8:480   active ready running<br>...<br><br><br>6. 동일한 방법으로 재스캔 및 Multipath reload 도 해 보았으나 해결 안됨.<br><br>7. scsi-rescan -i 방법으로 다시 시도<br><br>8. 아래와 같이 multipath 정상으로 복원<br># multipath -ll<br>...<br>mpathal (360060e8007c7fb000030c7fb00000c19) dm-22 HITACHI ,OPEN-V<br>size=800G features='1 queue_if_no_path' hwhandler='0' wp=rw<br>`-+- policy='service-time 0' prio=1 status=active<br>  |- 1:0:0:30 sdii 135:32  active ready running<br>  |- 1:0:1:36 sdei 128:160 active ready running<br>  |- 4:0:0:30 sdjk 8:480   active ready running<br>  `- 4:0:1:36 sdej 128:176 active ready running<br>...</environment><periodicityOfIssue>위와 같이 조치를 하여 모든 path 에 대해 정상화는 했습니다.<br><br>문의 드릴 사항은 위에서 수행했던 두 가지 스캔 방식에 대한 정확한 차이점에 대해 알고 싶습니다.<br><br>만약 운영 도중 dev_loss 가 발생하여 Path 를 복원할 때 위와 같이 2번의 절차를 수행해야 하는지도 확인 부탁드립니다.<br><br>감사합니다.</periodicityOfIssue><cep>false</cep></case>